<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
  <title>Test test</title>
</head>

<style>
:root {
    --main-row-size: 24;
    --main-font-size: 12;
    --tooltip-song-size: 250;
}

body {
    overflow: hidden;
    width: 100%;
    font-family: 'Roboto', sans-serif;
    font-size: var(--main-font-size);
}

div.data {
  position: absolute;
  padding: 4px 0px;
  height: 100%;
  overflow:hidden;
  display:inline-block;
  text-overflow: ellipsis;
  white-space: nowrap;
  margin-left: auto;
  margin-right: auto;
  vertical-align: middle;
  }

div.headers {
  position: absolute;
  width: 100%;
  border: 2px rgba(75, 75, 75, 0.5);
  border-style: solid;
  border-radius: 5px;
  height: var(--main-row-size);
}

div.datarow {
  position: absolute;
  width: 100%;
  border: 1px rgba(0, 0, 0, 0.51) solid;
  border-radius: 5px;
  background: rgba(126, 126, 126, 0.5);
  height: var(--main-row-size);
  text-align: left;
}

div.table-container {
    position: absolute;
    overflow: scroll;
}

div[cell_type="p"] {
/*     display: inline-block; */ 
    color: rgb(188, 188, 188);
    left: 0%;
    width: 35px;
    text-align: right;
    margin-left: 5px; 
    display: flex;    
}

div[cell_type="n"] {
    color: rgb(188, 188, 188);
    left: 10%;
    width: calc(40% - 5px);
}

div[cell_type="a"] {
    color: rgb(188, 188, 188);
    left: 50%;
    width: calc(50% - 105px);
}

div[cell_type="s"] {
    color: rgb(188, 188, 188);
    right: 0;
    width: 100px;
}

div.info {
  position: absolute;
  right: 0px;
  opacity: 1;
  z-index: 1;	
  display: flex;
  align-items: center;
}

div.header {
  position: absolute;
  padding: 0 0px;
  overflow: hidden;
  margin-left: 0px;
}

div.header[cell_type="p"] {
  position: absolute;
  padding: 0 0px;
  overflow: hidden;
  margin-left: 5px;
  width: 10%;
}

image {
/*   z-index: 999;
 */}

div[is_new="enter"] {
    background-color: rgba(255, 255, 96, 0.5);
    
}

div.table {
  position:relative;
  left: 0px;
  width: 100%;
}

svg.triangle {
    position: absolute;
   /* width: 20px;
    height: 20px; */
    top: 6px;
    right: 0px;
    opacity: 0.5;
    margin: 0 auto;
    display: block;
}

svg.radar {
  z-index : 3;
}

svg.info {
  margin: 0 auto;
  display: block;
}

div.song_tooltip {	
    position: absolute;			
    text-align: center;			
    width: var(--tooltip-song-size);					
    height: var(--tooltip-song-size);	;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: rgba(116, 116, 116, 0.496);	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;
    z-index: 2;	
    display: inline-flex;	
}


/* .table-container::-webkit-scrollbar {
  width: 10px;
  background-color: rgba(0, 0, 0, 0.667);
}

.table-container::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 5px;
} */

.table-container::-webkit-scrollbar-track
{
	-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
	border-radius: 10px;
	background-color: rgba(245, 245, 245, 0.503);
}

.table-container::-webkit-scrollbar
{
	width: 12px;
	background-color: rgba(245, 245, 245, 0);
}

.table-container::-webkit-scrollbar-thumb
{
	border-radius: 10px;
	-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);
	background-color: #555;
}

.d3-tip {
  line-height: 1;
  font-weight: 300;
  padding: 3px;
  background: rgba(145, 145, 145, 0.509);
  /* color: #fff; */
  border-radius: 2px;
  pointer-events: none;
  text-align: center;
  text-shadow: 0 1px 0 rgba(255, 255, 255, 0.53), 1px 0 0 rgba(255, 255, 255, 0.53), -1px 0 0 rgba(255, 255, 255, 0.53), 0 -1px 0 rgba(255, 255, 255, 0.53);
  cursor: default;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 80%;
  line-height: 1;
  /* color: rgba(145, 141, 141, 0.503); */
  position: absolute;
  pointer-events: none;
}

/* Eastward tooltips */
.d3-tip.e:after {
  content: "\25C0";
/*   margin: -4px 0 0 0;
 */  top: 10%;
     /* left: -8px; */
}

text.axisLabel {
  fill: #262626 !important;
}

</style>

<body style="margin: 0; background: #222222">
  <div id="container" style="width:100%; margin: 0px;">                                   
    <div id="left" style="float:left; width:75%; margin: 0px;"> 
    </div>                     
    <div id="right" style="float:right; width:25%; margin: 0px;"> 
      <input id="song_input" hidden="true"/>
      <button id="go_button" hidden="true">Show infos</button>
      <div id="controls" />
    </div>                   
  </div>   
  
</body>



<link rel="stylesheet" type="text/css" href="music.css">
<link rel="stylesheet" href="complete/awesomplete.css" />
<script src="complete/awesomplete.js" async></script>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="utils.js"></script>
<script src="https://s3.amazonaws.com/stitch-sdks/js/library/stable/stitch.min.js"></script>
<link rel="stylesheet" href="streamgraph.css"></script>
<script src="streamgraph.js"></script>
<!--<script src="stitch.js"></script>-->
<script src="radarChart.js"></script>	
<script src="tip.js"></script>
<script>


//-----------------------------------

let leftDiv = document.getElementById("left");

let width = leftDiv.clientWidth;
let height = window.innerHeight - 10;

/*
let width = 1200,
    height = 600;*/

let projection = d3.geoMercator()
    .scale(150)
    .translate([width / 2 - 80, height / 2 + 0])
    .precision(.1);

let path = d3.geoPath()
    .projection(projection);

let graticule = d3.geoGraticule();

let svg = d3.select("#left").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("transform", "translate(" + 0 + "," + 0 + ")");

let map = svg.append("g")
    .attr("width", width)
    .attr("height", height);

let rankPage = d3.select("#left").append("div")
    .attr("class", "table-container")
    .style("width", width + "px")
    .style("height", height + "px")
/*
    .attr("class", "node")
    .attr("width", width)
    .attr("height", height)
    .attr("x", 0)
    .attr("y", 0)
    .style("width", width + "px")
    .style("height", height + "px");*/

map.append("defs").append("path")
    .datum({type: "Sphere"})
    .attr("id", "sphere")
    .attr("d", path);

let navigationMap = true;

let navigation = svg.append("image")
    .attr("xlink:href","img/arrow_circle.svg")
    .attr("width", 60)
    .attr("height", 60)

navigation
  .attr("transform", "translate(" + ((width/2)-(navigation.node().getBoundingClientRect().width / 2)) + "," + (height - navigation.node().getBoundingClientRect().height) + ")");

navigation.on("click", function() {
    /*

    let countryRankingCallback = function(timeLine) {
        console.log(JSON.stringify(timeLine))
    }

    let firstDate = new Date("2017-07-01T07:00:00.000Z");
    let secDate = new Date("2017-07-08T07:00:00.000Z");

    getAllDocuments(db.collection('entries'), {"r":"us", "d":{ $lt: secDate, $gte: firstDate }}, countryRankingCallback, [], {_id: 0, s: 1, n:1, a:1})
    */


    if(navigationMap) {

      navigation.transition()
        .attr("transform", "translate(" + ((width/2)+(navigation.node().getBoundingClientRect().width / 2)) + "," +  navigation.node().getBoundingClientRect().height + ") rotate(180)")
        .duration(1000) 
        .delay(200)     

      map.transition()
        .attr("transform", "translate(0, " + (-height) + ")")
        .duration(1000) 
        .delay(200)    

        let histogram_height = 50;

        if(histogram) {
            histogram_height = histogram.node().getBoundingClientRect().height;
        }

      rankPage.transition()
        .style("top", (navigation.node().getBoundingClientRect().height + histogram_height + 20) + "px")
        .duration(1000) 
        .delay(200)    

      navigationMap = false
    } 
    else {
      navigation.transition()        
        .attr("transform", "translate(" + ((width/2)-(navigation.node().getBoundingClientRect().width / 2)) + "," + (height - navigation.node().getBoundingClientRect().height) + ") rotate(0)")
        .duration(1200) 
        .delay(0)   

      map.transition()
        .attr("transform", "translate(0, " + 0 + ")")
        .duration(1200) 
        .delay(0)     

      rankPage.transition()
        .style("top", (height + 10) + "px")
        .duration(1000) 
        .delay(0)   

      navigationMap = true
    }


    histogramTransition();
  })

function histogramTransition() {

  if(histogram) {   
    if(navigationMap) {
      histogram.transition()
        .attr("transform", "translate(" + ((width/2)-(histogram.node().getBoundingClientRect().width / 2)) + "," + (height - navigation.node().getBoundingClientRect().height - histogram.node().getBoundingClientRect().height) + ")")
        .duration(1000) 
        .delay(200)   
    }
    else {   
      if(histogram) {      
        histogram.transition()
          .attr("transform", "translate(" + (width-histogram.node().getBoundingClientRect().width) + "," + (navigation.node().getBoundingClientRect().height + 10) + ")")
          .duration(1200) 
          .delay(0)     
      }  
    }
  }
}
/*
map.append("use")
    .attr("class", "fill")
    .attr("xlink:href", "#sphere");*/
/*
map.append("rect")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("fill", d3.color("#00FFFFFF"));*/


map.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path);

let div = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);

let histogram;


const client = new stitch.StitchClient('dataviz-xeqhx');
const db = client.service('mongodb', 'mongodb-atlas').db('music');

const NorthAmerica = ["us","ca"];
const CentralAmerica = ["do","pa","mx","cr","gt","sv","hn"];
const SouthAmerica = ["ar","br","ec","bo","uy","cl","py","pe","co"];
const Asia = ["jp","ph","id","my","sg","hk","tw"];
const Europe = ["se","hu","pl","be","gr","es","fi","at","ch","sk","gb","pt","is","de","fr","it","nl","cz","cy","dk","ie","ee","lt","no","tr","lv"];
const Oceania = ["au","nz"];

let CountryContinentDict = {};
for(let i = 0; i < NorthAmerica.length; i++) {
  CountryContinentDict[NorthAmerica[i]] = "North America"
}
for(let i = 0; i < CentralAmerica.length; i++) {
  CountryContinentDict[CentralAmerica[i]] = "Central America"
}
for(let i = 0; i < SouthAmerica.length; i++) {
  CountryContinentDict[SouthAmerica[i]] = "South America"
}
for(let i = 0; i < Europe.length; i++) {
  CountryContinentDict[Europe[i]] = "Europe"
}
for(let i = 0; i < Asia.length; i++) {
  CountryContinentDict[Asia[i]] = "Asia"
}
for(let i = 0; i < Oceania.length; i++) {
  CountryContinentDict[Oceania[i]] = "Oceania"
}

const lowestDate = new Date("2017-01-01T12:00:00.000Z");
let midDate = new Date("2017-07-01T00:00:00.000Z");
let selectedSongID;

let countries;
let spotify_countries;
let streamsDict = {};

let getAllDocuments = function(collection, query, callback, documents, projection) {
    //console.log(query)
    //console.log(projection)
    collection.find(query,{project: projection, limit:10000}).then(items => {
      documents = documents.concat(items);
      
      if(items.length >= 10000) {
        let last_id = documents[documents.length - 1]["_id"];
        console.log(last_id);
        query["_id"] = {"$gt":last_id}
        getAllDocuments(collection, query, callback, documents, projection);
      }
      else {
        callback(documents);
      }
    })
  }


let songListCallback = function(list) {
  // Map songs to label and value to be displayed in the autocomplete input
  songsList = list.map(function(x) {
    return {
      label: x["Track Name"] + " - " + x["Artist"], 
      value: { text: x["Track Name"], id: x["id"] }
    }
  });


  // Set the autocomplete input
  let input = document.getElementById("song_input");
  new Awesomplete(input, {
    list: songsList, 
    replace: function(item) {
      //console.log(item.value.id);
      selectedSongID = item.value.id;
      this.input.value = item.value.text;
    }
  });

  // Display the autocomplete input
  input.hidden = false;

  let button = document.getElementById("go_button");
  button.hidden = false;
  button.onclick = function() {    
    if(selectedSongID && spotify_countries) {

      let songEntriesCallback = function(timeLine) {

        timeLine = timeLine.filter(x => x.r != 'global')

        spotify_countries.forEach(function(d, i) {
          let filtered = timeLine.filter(x => d == x.r);
          let aggregation = filtered.map(x => parseInt(x.s)).reduce(function(a, v) {
              return a + v;
          }, 0)
          //console.log(d)
          streamsDict[d] = aggregation;
          //console.log(streamsDict);
        })

        data = timeLine.map(function(x) {
          let region = "Unknown"
          if(x.r in CountryContinentDict) {
            region = CountryContinentDict[x.r]
          }
          else {
            console.log("Problem with" + x.r)
          }
          return {
            "value": parseInt(x.s),
            "key": region,
            "date": x.d.getFullYear() + "/" + ("0" + (x.d.getMonth() + 1)).slice(-2) + "/" + ("0" + x.d.getDate()).slice(-2)
          }
        });

        //console.log(data.map(d => d.date))
        
        regionsArray = ["Europe","North America","South America", "Central America", "Asia","Oceania"]
        datesArray = [];

        for(let i = 0; i < 34; i++) {
          let d = new Date(lowestDate.getTime());
          d.setDate(d.getDate() + i*7);
          datesArray.push(d.getFullYear() + "/" + ("0" + (d.getMonth() + 1)).slice(-2) + "/" + ("0" + d.getDate()).slice(-2))
        }

        fullData = []
        for(let j = 0; j < datesArray.length; j++) {
          fullData.push({"date": datesArray[j]})
          for(let i = 0; i < regionsArray.length; i++) {
            fullData[j][regionsArray[i]] = 0
          }
        }

        for(let i = 0; i < data.length; i++) {
          let dateIdx = datesArray.indexOf(data[i].date)
          let region = data[i].key

          fullData[dateIdx][region] += data[i].value
        }

        let format = d3.timeParse("%Y/%m/%d");

        fullData.forEach(function(d) {
          d.date = format(d.date);
        });

        if(histogram) {
          histogram = chart(fullData, "palette", svg, histogram);
        }
        else {
          histogram = chart(fullData, "palette", svg, histogram);

          histogram
          .attr("transform", "translate(" + (-histogram.node().getBoundingClientRect().width) + "," + (height - navigation.node().getBoundingClientRect().height - histogram.node().getBoundingClientRect().height) + ")")

          histogramTransition();
        }

        console.log(histogram)

      }

      getAllDocuments(db.collection('entries'), {"id":selectedSongID}, songEntriesCallback, [], {_id: 0, s: 1, r:1, d: 1})
    }
  }
}

client.login().then(() => getAllDocuments(db.collection('songs'), {}, songListCallback, [], {_id: 0, id: 1, "Track Name": 1, "Artist": 1}))

d3.json("world-50m.json", function(error, world) {

  if (error) throw error;

  countries = topojson.feature(world, world.objects.countries).features, neighbors = topojson.neighbors(world.objects.countries.geometries);
  console.log(countries);
  
  d3.json("id_dict.json", function(error, dict) {
    countries.forEach(function(d, i) {
      if(dict["" + parseInt(d.id)]) {
        d.name = dict[d.id][1]
        d.alpha2 = dict[d.id][0]
      }
    })

    d3.json("Datasets/countries.json", function(error, c) {
        spotify_countries = c;
        let spotify_dict = {}
        spotify_countries.forEach(function(d, i) {
          spotify_dict[d] = d
        })

        //console.log(spotify_dict)

        countries = countries.filter(d => d.alpha2 != "aq")

        map.selectAll(".country")
          .data(countries)
          .enter().insert("path", ".graticule")
          .attr("class", "country")
          .attr("d", path)
          //.style("fill", function(d, i) { return color(d.color = d3.max(neighbors[i], function(n) { return countries[n].color; }) + 1 | 0); })
          .style("fill", function(d, i) { 
            if(d.alpha2 in spotify_dict) {
              //return d3.color("#6AE368")
              return d3.color("#81b71a")
            }
            else {
              return d3.color("#828282")
            }
          })

          .on("mouseover", function(d) {    
              div.transition()    
                  .duration(200)    
                  .style("opacity", 1);    
              })    

          .on("mousemove", function(d) {
              if(d.name) {
                if(streamsDict[d.alpha2] !== undefined) {
                  div .html(d.name + "<br>Yearly Streams: " + streamsDict[d.alpha2])  
                      .style("left", (d3.event.pageX) + "px")   
                      .style("top", (d3.event.pageY - 28) + "px");  
                }
                else {
                  div .html(d.name)  
                      .style("left", (d3.event.pageX) + "px")   
                      .style("top", (d3.event.pageY - 28) + "px");  
                }
              }
              else {
                div .html(d.id)  
                    .style("left", (d3.event.pageX) + "px")   
                    .style("top", (d3.event.pageY - 28) + "px");  
              }
          })
          .on("mouseout", function(d) {   
              div.transition()    
                  .duration(500)    
                  .style("opacity", 0); 
          })
          /*
          .on("click", function(d) {

            svg.insert("path", ".graticule")
              .datum(topojson.mesh(world, world.objects.countries, function(a, b) { 
                return (a.id == d.id || b.id == d.id)}))
              .attr("class", "selectedBoundary")
              .attr("d", path);
          });*/

          // Draw the boundaries
          map.insert("path", ".graticule")
            .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
            .attr("class", "boundary")
            .attr("d", path);

    });

  });
  

});

  function reporter(x) {
      //console.log(x.name)
      d3.select("#report").text(function() {
          if(x.name) {
            return (x.name);
          }
          return (x.id);
      });
  }


d3.select(self.frameElement).style("height", height + "px");


//-----------------------------TOPLIST------------------------------------------

// VARIABLES

let style = getComputedStyle(document.body);
let row_size = +style.getPropertyValue('--main-row-size') + 4;
let data_row_size = row_size - 2;
let triangle_width = 13;
let triangle_height = 13;
let indexx = 1;
let uniqueID = 0;
let testDataset = [];
let features = {"acousticness": 0.187,	"danceability": 0.852, "energy": 0.773,	"instrumentalness": 0.0000305, "liveness": 0.159,	"speechiness": 0.0776, "valence": 0.907};
		
function parseFeatures(features){
  let temp = JSON.parse(JSON.stringify(features));
  let temp2 = {};
  temp2['axes'] = JSON.parse(JSON.stringify(d3.entries(temp)).replace(/key/g, "axis"));

  return [temp2];
}

// Define the div for the tooltip
let div_toplist = d3.select("body").append("div")	
    .attr("class", "song_tooltip")				
    .style("opacity", 0);

let tip = d3.tip().attr('class', 'd3-tip').offset([20, 30]).html("<div class='radar'></div>");

// Create a local variable for storing previous data.
let previousData = d3.local();

d3.json("./jsonsamples/us_with_id.json", function(error, data) {

    console.log(data);
    testDataset = data;
    createToplist(data);
    });


// Fake data
/* let tweets = {
"tweets": [
{"pos": 1, "title": "I really love seafood.", "author": "author1", "streams": 456546546},
{"pos": 2, "title": "I take that back, this doesn't taste so good.", "author": "author14", "streams": 546546},
{"pos": 3, "title": "From now on, I'm only eating cheese sandwiches.", "author": "author1324", "streams": 4645},
{"pos": 4, "title": "Great workout!", "author": "author1454", "streams": 2354656},
{"pos": 5, "title": "Spectacular oatmeal!", "author": "6756", "streams": 2354656},
{"pos": 6, "title": "Amazing traffic!", "author": "author145546", "streams": 2354656},
{"pos": 7, "title": "Just got a ticket for texting and driving!", "author": "author12343", "streams": 2354656},
{"pos": 8, "title": "Going to have some boiled eggs.", "author": "author123543", "streams": 2354656},
{"pos": 9, "title": "Maybe practice some gymnastics.", "author": "author134654", "streams": 2354656},
{"pos": 10, "title": "@Roy Let's get lunch", "author": "author13453454", "streams": 567567}
]
} */

let tweets3 = {
"tweets": [
{"p": 1, "n": "Nic", "a": "author1", "s": 346454, "id": 1234324523423},
{"p": 2, "n": "Bic", "a": "a2", "s": 4345, "id": 1234324523423},
{"p": 3, "n": "tric", "a": "a14", "s": 2354656, "id": 1234324523423},
{"p": 4, "n": "pic", "a": "a13454", "s": 2354656, "id": 1234324523423},
{"p": 5, "n": "Spectacular oatmeal!", "a": "a13454", "s": 2354656, "id": 1234324523423},
{"p": 6, "n": "Amazing traffic!", "a": "a1356456", "s": 2354656, "id": 1234324523423},
{"p": 7, "n": "Just got a ticket for texting and driving!", "a": "a1564", "s": 2354656, "id": 1234324523423},
{"p": 8, "n": "Going to have some boiled eggs.", "a": "a134565465", "s": 2354656, "id": 1234324523423},
{"p": 9, "n": "Maybe practice some gymnastics.", "a": "a1356546", "s": 2354656, "id": 1234324523423},
{"p": 10, "n": "@Roy Let's get lunch", "a": "a143564565", "s": 3453454, "id": 1234324523423}
]
}
 
// toplistData - list of json-like elements
function createToplist(toplistData){  
    var keyValues = d3.keys(toplistData[0]);
    let keys = {"p": "#","n": "Title", "a": "Artist", "s": "Streams"};
    let head = rankPage
        .append("div")
        .attr("class", "table")
        .append("div")
        .attr("class", "headers")
        .style("height", data_row_size + "px");

    head.selectAll("div.header")
        .data(d3.entries(keys))
        .enter()
        .append("div")
        .attr("class", "header")
        .attr("cell_type", (d) => {return d.key;})        
        .html((d, i) => {return d.value;});

    let data_rows = d3.select("div.table").selectAll("div.datarow")
        .data(toplistData, (d) => {return d.n;})
        .enter()
        .append("div")
        .attr("class", "datarow")
        .attr("id", function(d) { return uniqueID++; })
        .style("height", data_row_size + "px")
        .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size)) + "px";});

    data_rows.selectAll("div.data")
        .data((d) => { return d3.entries((({ p, n, a, s }) => ({ p, n, a, s }))(d));})
        .enter()
        .append("div")
        .attr("class", "data")
        .attr("cell_type", (d) => {return d.key;})
        .html((d) => {return d.value;});

    let info_image = data_rows
        .append("div")
          .attr("class", "info")
          .style("height", data_row_size + "px")
          .style("width", data_row_size + "px")
        .append("svg")
          .attr("width", 24 + "px")
          .attr("height", 24 + "px")
          .attr("class", "info")
        .append("image")
          .attr("xlink:href","img/info_icon.png")
          .attr("width", 24 + "px")
          .attr("height", 24 + "px")
          .on('mouseover', function(d) {     
            d3.select(".d3-tip").transition().style("opacity", "1");   
            tip.show(d);
            let svg_radar2 = RadarChart(".radar", parseFeatures(features), radarChartOptions2);                    
          })
          .on('mouseout', function(d) {
            d3.select(".d3-tip").transition().duration(1000).style("opacity", "0").on("end", () => {d3.select("svg.radar").remove(); tip.hide;});
            
          });
          /* .on("mouseover", function(d) {		
              div_toplist.transition()		
                  .duration(200)		
                  .style("opacity", .9);		
              div_toplist	
                  .style("left", (d3.event.pageX + 10) + "px")		
                  .style("top", (d3.event.pageY - 10) + "px");

              let svg_radar2 = RadarChart(".song_tooltip", data_radar, radarChartOptions2);
            })					
          .on("mouseout", function(d) {		
              div_toplist.transition()		
                  .duration(500)		
                  .style("opacity", 0);}) */
      info_image.call(tip);

    d3.select(".d3-tip")
        .on('mouseover', function(d) { d3.select(".d3-tip").transition().style("opacity", "1");})
        .on('mouseout', function(d) {d3.select(".d3-tip").transition().duration(1000).style("opacity", "0")
            .on("end", () => {d3.select("svg.radar").remove(); tip.hide;}); });

    //data_rows.on("click", showDetails);

    d3.selectAll("[cell_type = p]")
        .each(function(d) { previousData.set(this, d.value) });
}    

function transitionSheet() {
    d3.selectAll("div.datarow")
    .transition()
    .duration(2000)
    .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size)) + "px";});
    }

function sortSheet() {
    var dataset = d3.selectAll("div.datarow").data();
    dataset.sort((a,b) => {return a.p > b.p;
        });

    d3.selectAll("div.datarow")
    .data(dataset, (d) => {return d.title;})
    .transition()
    .duration(2000)
    .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size));});
    }   

function transformData() {

    // Section that only create fake data for testing purposes
    // Copy to a new variable 
    let tweets2 = JSON.parse(JSON.stringify(tweets3));
    // Add new record
    if (Math.random() > 0.3){
        while(Math.random() > 0.3){
            tweets2.tweets.push({"p": Math.round(Math.random()*20), "n": "Newone" + indexx++, 
            "a": "author1" + indexx, "s": Math.round(Math.random()*1000000), "id": 1234324523423});
        }
    }
    
    // Shuffle records
    tweets2.tweets = shuffle(tweets2.tweets);
    //Remove some of the records
    tweets2.tweets = tweets2.tweets.splice(0, tweets2.tweets.length-Math.round(Math.random()*2));
    //New ranking
    let ranking = d3.range(1, tweets2.tweets.length+1)
    // Change position of each record
    tweets2.tweets.forEach( (item, index) => {
        item.p = ranking[index];
    });

    tweets3 = JSON.parse(JSON.stringify(tweets2));

    updateToplist(tweets2.tweets);

    function updateToplist(newToplist){ 

        // Update those that are in the table
        let rows = d3.select("div.table")
            .selectAll("div.datarow")
            .data(newToplist, (d) => {return d.n;})
            .call(savePreviousData)
            .attr("is_new", "update");
        
        let cells = rows.selectAll("div.data")
            .data((d) => {return d3.entries((({ p, n, a, s }) => ({ p, n, a, s }))(d));})
            .html((d) => {return d.value;})
            .attr("is_new", "update");

        rows.transition("sorting")
            .delay((d) => {return 100 + (d.p/newToplist.length) * 2000;})
            .duration(2000)
            .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size)) + "px";})
            .on("start", addTriangle);

        // Add new ones
        let enterRows = rows.enter()
            .append("div")
            .attr("class", "datarow")
            .attr("id", function(d) { return uniqueID++; })
            .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size)) + "px";})
            .style("opacity", 0.0)
            .style("left", "-600px")
            .style("height", data_row_size + "px")
            .attr("is_new", "enter");
            //.on("click", showDetails);

        let enter_info = enterRows
        .append("div")
        .attr("class", "info")
        .style("height", data_row_size + "px")
        .style("width", data_row_size + "px")
      .append("svg")
        .attr("width", 24 + "px")
        .attr("height", 24 + "px")
      .append("image")
        .attr("xlink:href","img/info_icon.png")
        .attr("width", 24 + "px")
        .attr("height", 24 + "px")
        .on('mouseover', function(d) {     
            d3.select(".d3-tip").transition().style("opacity", "1");   
            tip.show(d);
            let svg_radar2 = RadarChart(".radar", parseFeatures(features), radarChartOptions2);                    
          })
          .on('mouseout', function(d) {
            d3.select(".d3-tip").transition().duration(1000).style("opacity", "0").on("end", () => {d3.select("svg.radar").remove(); tip.hide;});
            
          });
          /* .on("mouseover", function(d) {		
              div_toplist.transition()		
                  .duration(200)		
                  .style("opacity", .9);		
              div_toplist	
                  .style("left", (d3.event.pageX + 10) + "px")		
                  .style("top", (d3.event.pageY - 10) + "px");

              let svg_radar2 = RadarChart(".song_tooltip", data_radar, radarChartOptions2);
            })					
          .on("mouseout", function(d) {		
              div_toplist.transition()		
                  .duration(500)		
                  .style("opacity", 0);}) */
          enter_info.call(tip);

    /* d3.select(".d3-tip")
        .on('mouseover', function(d) { d3.select(".d3-tip").transition().style("opacity", "1");})
        .on('mouseout', function(d) {d3.select(".d3-tip").transition().duration(1000).style("opacity", "0")
            .on("end", () => {d3.select("svg.radar").remove(); tip.hide;}); }); */

/*         .on("mouseover", function(d) {		
            div_toplist.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div_toplist.html(d.id)	
                .style("left", (d3.event.pageX + 10) + "px")		
                .style("top", (d3.event.pageY - 10) + "px");	
            console.log(d.id);
            })					
        .on("mouseout", function(d) {		
            div_toplist.transition()		
                .duration(500)		
                .style("opacity", 0);	
      }); */

        let enterCells = enterRows.selectAll("div.data")
            .data((d) => {return d3.entries((({ p, n, a, s }) => ({ p, n, a, s }))(d));})
            .enter()
            .append("div")
            .attr("class", "data")
            .attr("cell_type", (d) => {return d.key;})
            .html((d) => {return d.value;});
        
        enterRows.transition("new_rows")
            .ease(d3.easeQuad)
            .delay(3100)
            .duration(1000)
            .style('opacity', 1.0)
            .style("left", "0px");

        rows.exit()
            .attr('is_new', 'exit')
            .transition("exit_rows")
            .ease(d3.easeQuad) //"quad" d3.v3
            .delay(0)
            .duration(1000)
            .style('opacity', 0.0)
            .style("left", "600px")
            .remove();
    }                   
    function addTriangle() {
        //let inner_data = d3.select(this).selectAll("[cell_type = p]").data();
        //console.log(inner_data[0]);

        d3.select(this).selectAll("[cell_type = p]")
            .append('svg')
            .attr("class", "triangle")
            .attr("height", triangle_height + "px")
            .attr("width", triangle_width + "px")
            .style("right", 0 + 'px')
                .append('polygon')
                .attr('points', function(d) {
                    console.log(+previousData.get(this));
                    console.log(+d.value);                    
                    var diff = +previousData.get(this) - d.value;  // Retrieve previously stored data.               
                    return diff < 0 ? "0,0 " + triangle_width + ",0 " + triangle_width/2 +"," + triangle_height + " 0,0" : 
                            diff > 0 ? "0," + triangle_height +" " + triangle_height+","+triangle_width+" "+triangle_width/2+",0 0,"+triangle_height :
                            "0," + triangle_height/2 + " " + triangle_width+","+triangle_width/2+" 0," + triangle_width/2;
                    })
                .style("fill" ,function(d) {
                    var diff = +previousData.get(this) - d.value; 
                    return diff < 0 ? "red" : diff > 0 ? "green" : "black";
                    })
                .style("stroke" ,function(d) {
                    var diff = +previousData.get(this) - d.value; 
                    return diff === 0 ? "black" : "";
                    })
                .style("opacity", 0)
                .transition()
                .duration(1000)
                .ease(d3.easeLinear)
                .style("opacity", 1);
    }
    function savePreviousData() {
        d3.selectAll("[cell_type = p]").each(function(d) { console.log(this); previousData.set(this, d.value) });
    }
    function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }
}

function showDetails()
{
    let movingRows = d3.selectAll("div.datarow")
        .filter((d) => d.p > d3.select(this).datum().p);

    let movingRowsNodes = movingRows.nodes();

    movingRows.transition()
        .duration(1000)
        .style("top", (d, i) => { return +d3.select(movingRowsNodes[i]).style("top").slice(0,-2) + 30 + "px"});
}



d3.select("#controls").insert("button", ".table").on("click", sortSheet).html("sort")
d3.select("#controls").insert("button", ".table").on("click", transitionSheet).html("transition")
d3.select("#controls").insert("button", ".table").on("click", transformData).html("transform")

//////////////////////////////////////////////////////////////
//////////////////////// Set-Up //////////////////////////////
//////////////////////////////////////////////////////////////

var margin_radar = { top: 30, right: 40, bottom: 30, left: 40 },
width_radar = +style.getPropertyValue('--tooltip-song-size') + 60 - margin_radar.left - margin_radar.right,
height_radar = +style.getPropertyValue('--tooltip-song-size') - margin_radar.top - margin_radar.bottom;

//////////////////////////////////////////////////////////////
////////////////////////// Data //////////////////////////////
//////////////////////////////////////////////////////////////

var data_radar = [
  { name: 'Allocated budget',
    axes: [
      {axis: 'Sales', value: 42},
      {axis: 'Marketing', value: 20},
      {axis: 'Development', value: 60},
      {axis: 'Customer Support', value: 26},
      {axis: 'Information Technology', value: 35},
      {axis: 'Administration', value: 20}
    ]
  },
  { name: 'Actual Spending',
    axes: [
      {axis: 'Sales', value: 50},
      {axis: 'Marketing', value: 45},
      {axis: 'Development', value: 20},
      {axis: 'Customer Support', value: 20},
      {axis: 'Information Technology', value: 25},
      {axis: 'Administration', value: 23}
    ]
  }
];

/*     //////////////////////////////////////////////////////////////
////// First example /////////////////////////////////////////
///// (not so much options) //////////////////////////////////
//////////////////////////////////////////////////////////////
var radarChartOptions = {
  w: 290,
  h: 350,
  margin: margin,
  levels: 5,
  roundStrokes: true,
  color: d3.scaleOrdinal().range(["#26AF32", "#762712"]),
  format: '.0f'
};

// Draw the chart, get a reference the created svg element :
let svg_radar1 = RadarChart(".radarChart", data, radarChartOptions); */

//////////////////////////////////////////////////////////////
///// Second example /////////////////////////////////////////
///// Chart legend, custom color, custom unit, etc. //////////
//////////////////////////////////////////////////////////////
var radarChartOptions2 = {
  w: width_radar,
  h: height_radar,
  margin: margin_radar,
  maxValue: 1,
  levels: 5,
  roundStrokes: false,
  color: d3.scaleOrdinal().range(["#AFC52F", "#ff6600"]),
  format: '.2f',
  opacityArea: 0.2,
  opacityCircles: 0.01,
  wrapWidth: 100,
  //legend: { title: 'Organization XYZ', translateX: 100, translateY: 40 },
  //unit: '$'
};

// Draw the chart, get a reference the created svg element :
//let svg_radar2 = RadarChart(div_toplist, data_radar, radarChartOptions2);
</script>