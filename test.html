<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Music is uncountable</title>
  <!--
  <link rel="stylesheet" href="complete/awesomplete.css" /> 
  <script src="complete/awesomplete.js" async></script>-->
  <script type="text/javascript" src="complete/autocomplete.js"></script>
  <link rel="stylesheet" href="complete/autocomplete.css"/>


  <link rel="stylesheet" href="css/index.css"/>
</head>


<body style="margin: 0; background: #222222">
  <nav class="main-menu" style="min-width: 400px; width: 35vw; right:0;background-color: rgb(66, 66, 66);">
    <div class="menu-content">
      <div class="tabsel" style = "height:10vh;">
        <button id = "btnSongs" class="tablinks" onclick="Open(event, 'Songs')" style = "height:10vh; width: 50%;">Songs</button>
        <button id = "btnCountries" class="tablinks" onclick="Open(event, 'Countries')" style = "height:10vh; width: 50%;">Countries</button>
      </div>

      <div id="Songs" class="tabcontent" style = "height:90vh;">
        <h1 style="font-size: 20px" class="info_text">♪ Search a song using the research bar or select a song from the list! ♪</h1>
        <div style="height: 60px">
          <div id="autocomplete"></div>
        </div>
        <div>
          <h2 style="width: 100%; text-align: center">Trending songs</h2>
          <div id="popular_songs"></div>
        </div>
      </div>

      <div id="Countries" class="tabcontent" style = "height:90vh;  overflow:scroll;">
        <h1 style="font-size: 20px" class="info_text">♪ Click on the map or on the list below to select a country! ♪</h1>
        <p></p> 
      </div>
    </div>
  </nav>

  <div id="container" class="container" style="width:100%; margin: 0px;">                                   
    <div id="left" class="column" style="float:left; width:65vw; margin: 0px; height:100vh;"> 
    </div>                     
    <div id="right" class="column" style="float:right; width:35vw; margin: 0px; height:100vh;"> 
	 </div>      
	 <div id="controls" ></div>	
  </div>   
</body>



<link href="https://fonts.googleapis.com/css?family=Frank+Ruhl+Libre" type="text/css" rel="stylesheet">
<!--<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">-->


<link rel="stylesheet" type="text/css" href="music.css">

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="js/utils.js"></script>
<script src="https://s3.amazonaws.com/stitch-sdks/js/library/stable/stitch.min.js"></script>
<link rel="stylesheet" href="css/streamgraph.css"></script>
<script src="js/streamgraph.js"></script>
<link rel="stylesheet" href="css/ranklegend.css"></script>
<script src="js/ranklegend.js"></script>
<script src="js/worldmap.js"></script>
<!--<script src="stitch.js"></script>-->
<script src="radarChart.js"></script>	
<script src="tip.js"></script>
<script>


let leftDiv = document.getElementById("left");
let rightDiv = document.getElementById("right");

let width = leftDiv.clientWidth;
let height = window.innerHeight ;

let menu = d3.select(".main-menu")
let menuContent = d3.select(".menu-content")

let open = true;

function closeMenu() {
  open = false;
  menuContent.style("display", "none")
  menu.transition()
    .duration(250)
    .style("width", "36px")
    .style("min-width", "36px")
}

function openMenu() {
  if(!open)
  {
    open = true;
    menu.transition()
      .duration(400)
      .style("min-width", "400px")
      .style("width", "35vw")
    setTimeout(function() {
      if(open) {    
        menuContent
          .style("display", "initial")
      }
    }, 200)
  }
}

menu.on("mouseenter", function(d) {
  openMenu();
})

menu.on("mouseleave", function(d) {
  closeMenu();
})




/*
map.append("use")
    .attr("class", "fill")
    .attr("xlink:href", "#sphere");*/
/*
map.append("rect")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("fill", d3.color("#00FFFFFF"));*/


let countryTooltip = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);

let streamGraph;
let timelapseData;


const client = new stitch.StitchClient('dataviz-xeqhx');
const db = client.service('mongodb', 'mongodb-atlas').db('music');


const continents = ["Europe","North America","Latin America"/*"South America", "Central America"*/, "Asia & Oceania"/* "Asia","Oceania"*/]

const NorthAmerica = ["us","ca"];
const CentralAmerica = ["do","pa","mx","cr","gt","sv","hn"];
const SouthAmerica = ["ar","br","ec","bo","uy","cl","py","pe","co"];
const LatinAmerica = CentralAmerica.concat(SouthAmerica);
const Asia = ["jp","ph","id","my","sg","hk","tw"];
const Europe = ["se","hu","pl","be","gr","es","fi","at","ch","sk","gb","pt","is","de","fr","it","nl","cz","cy","dk","ie","ee","lt","no","tr","lv"];
const Oceania = ["au","nz"];
const AsiaOceania = Asia.concat(Oceania);

//const continentColors = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6"];
//const continentColors = ["#3377ff", "#ff5a33", "#ffad33", "#33ff3f", "#990099", "#0099c6"];
const continentColors = ["#295fcc", "#cc4829", "#cc8a29", "#29cc33", "#990099", "#0099c6"];
const continentColorsDict = {
  "Europe": continentColors[0],
  "North America": continentColors[1],
  "Latin America": continentColors[2],
  "Asia & Oceania": continentColors[3]
}


let CountryContinentDict = {};
for(let i = 0; i < NorthAmerica.length; i++) {
  CountryContinentDict[NorthAmerica[i]] = "North America"
}
for(let i = 0; i < CentralAmerica.length; i++) {
  CountryContinentDict[CentralAmerica[i]] = "Central America"
}
for(let i = 0; i < SouthAmerica.length; i++) {
  CountryContinentDict[SouthAmerica[i]] = "South America"
} 
for(let i = 0; i < LatinAmerica.length; i++) {
  CountryContinentDict[LatinAmerica[i]] = "Latin America"
} 
for(let i = 0; i < Europe.length; i++) {
  CountryContinentDict[Europe[i]] = "Europe"
}
for(let i = 0; i < Asia.length; i++) {
  CountryContinentDict[Asia[i]] = "Asia"
}
for(let i = 0; i < Oceania.length; i++) {
  CountryContinentDict[Oceania[i]] = "Oceania"
}
for(let i = 0; i < AsiaOceania.length; i++) {
  CountryContinentDict[AsiaOceania[i]] = "Asia & Oceania"
}

let colorScale = d3.scaleLinear()
    .domain([0,1])
    //.interpolate(d3.interpolateHcl)
    .interpolate(d3.interpolateRgb)
    .range([d3.rgb('#FF4444'), d3.rgb("#444444")]);

let colorScales = {
}

for(let continent in continentColorsDict) {
  colorScales[continent] =  d3.scaleLinear()
                              .domain([0,0.2,1])
                              //.interpolate(d3.interpolateHcl)
                              .interpolate(d3.interpolateRgb)
                              .range([d3.rgb(continentColorsDict[continent]), d3.interpolateRgb(d3.rgb(continentColorsDict[continent]),"#666")(0.5), d3.rgb("#666")]);
}

let svg = d3.select("#left").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("transform", "translate(" + 0 + "," + 0 + ")");

let worldDataReadyCallback = function() {
  setCountriesList();

}

let zoomCallback = function(alpha) {
  show_image(null);
  let countryInfoCallback = function(timeLine) {
    data = timeLine.map(function(x) {
      return {
        "value": parseInt(x.s),
        "id": x.id,
        "artist": x.a,
        "song": removeParentheses(x.n),
        "position": x.p,
        "date": x.d.getFullYear() + "/" + ("0" + (x.d.getMonth() + 1)).slice(-2) + "/" + ("0" + x.d.getDate()).slice(-2)
      }
    });

    datesArray = [];

    for(let i = 1; i < 34; i++) {
      let d = new Date(lowestDate.getTime());
      d.setDate(d.getDate() + i*7);
      datesArray.push(d.getFullYear() + "/" + ("0" + (d.getMonth() + 1)).slice(-2) + "/" + ("0" + d.getDate()).slice(-2))
    }

    timelapseData = []
    for(let j = 0; j < datesArray.length; j++) {
      timelapseData.push({"date": datesArray[j]})
    }

    for(let i = 0; i < data.length; i++) {
      let dateIdx = datesArray.indexOf(data[i].date)
      if(dateIdx > -1) {
        timelapseData[dateIdx][data[i].song] = data[i];
      }
    }

    let streamData = []
    for(let j = 0; j < datesArray.length; j++) {
      streamData.push({"date": datesArray[j]})
      streamData[j]["Streams"] = 0
    }

    for(let i = 0; i < data.length; i++) {
      let dateIdx = datesArray.indexOf(data[i].date)
      if(dateIdx > -1) {
        streamData[dateIdx]["Streams"] += data[i].value
      }
    }

    let format = d3.timeParse("%Y/%m/%d");

    streamData.forEach(function(d) {
      d.date = format(d.date);
    });

    let topListData = getCountryYearlyTopListData(timelapseData);

    createToplist(topListData, {"c_position": "#", "c_song": "Song", "c_formatted_streams": "Streams"}, ({c_position, c_song, c_formatted_streams}) => ({c_position, c_song, c_formatted_streams}), "streams", true);

    console.log(streamData)

    if(streamGraph) {
      streamGraph.remove();

      //streamGraphTransition(1000);
      //histogram = chart(width, height/6, streamData, "palette", svg, histogram);
    }

    streamGraphListener = {
      buttonPressed(playing, week) {
        if(playing) {
          startCountryTimeLapse(timelapseData, week)
        } else {

        }
      }
    }

    let rightWidth = rightDiv.clientWidth;
    streamGraph = new StreamGraph(7*rightWidth/10, 2*height/10 - 20, streamData, svgStreamGraph, streamGraphListener, ["#A2A2A2"], null, ["Streams"])

    streamGraph.streamGraph      
      .attr("transform", "translate(" + svgStreamGraph.node().getBoundingClientRect().width / 5 + "," +  (svgStreamGraph.node().getBoundingClientRect().height/5 + 300) + ")")


    streamGraphTransition(1000); 

    setTimeout(function() {

      width = leftDiv.clientWidth;
      height = window.innerHeight ;
      if(streamGraph) {


        let rightWidth = rightDiv.clientWidth;
        streamGraph.resize(7*rightWidth/10, 2*height/10 - 20)
        streamGraphTransition(0);
      }
    }, 1000);
    
  }

  topListText.text("Top chart in " + worldMap.spotify_dict[alpha].name)
	topListInfoText.text("♪ Hover the info icon to show information on the acousticness of the song ♪")
  getAllDocuments(db.collection('entries'), {"r":alpha, "p":{"$lt":101}}, countryInfoCallback, [], {_id: 0, id:1, s: 1, d:1, a: 1, n: 1, p:1})
}

let worldMap = new WorldMap(width, height, svg, continentColorsDict, CountryContinentDict, worldDataReadyCallback, zoomCallback);

let streamPage = d3.select("#right").append("div")
  .attr("class", "stream-container")
  .style("width", "calc(35vw - 36px)")
  .style("height", "30%")

streamPage
    .style("bottom", 0 + "px")
    .style("right", 36 + "px")

let rankPage = d3.select("#right").append("div")
    .attr("class", "table-container")
    .style("align-items", "center")
    .style("margin-left", "0px")
    .style("width", "calc(35vw - 36px)")
    .style("height", "70%")

let svgStreamGraph = streamPage.append("svg")

svgStreamGraph
  .attr("width","100%")
  .attr("height", "100%")

  /*
svgStreamGraph
    .attr("transform", "translate(" + 0 + "," + (7*svgStreamGraph.height()/10)+ ")");*/

let topListText = rankPage.append("h2")
  .text("")
  .style("margin", "10px")
  .style("text-align", "center")
  .style("color", "white")
  
  
let topListInfoText = rankPage.append("p").attr("class", "info_text")
  .text("")
  .style("margin", "10px")
  .style("text-align", "center")
  .style("color", "white")


rankPage
    .style("top", 0 + "px")
    .style("right", 36 + "px")

function streamGraphTransition(delay) {
  if(streamGraph) {
    streamGraph.streamGraph.transition()
      .attr("transform", "translate(" + svgStreamGraph.node().getBoundingClientRect().width / 5 + "," +  svgStreamGraph.node().getBoundingClientRect().height/5 + ")")
      .duration(delay) 
      .delay(0)   
  }
}


const lowestDate = new Date("2017-01-01T12:00:00.000Z");
let midDate = new Date("2017-07-01T00:00:00.000Z");
let selectedSong;

let streamsDict = {};

function linspace(start, end, n) {
    var out = [];
    var delta = (end - start) / (n - 1);

    var i = 0;
    while(i < (n - 1)) {
        out.push(start + (i * delta));
        i++;
    }

    out.push(end);
    return out;
}



let getAllDocuments = function(collection, query, callback, documents, projection) {
  //console.log(query)
  //console.log(projection)
  collection.find(query,{project: projection, limit:10000}).then(items => {
    documents = documents.concat(items);
    
    if(items.length >= 10000) {
      let last_id = documents[documents.length - 1]["_id"];
      query["_id"] = {"$gt":last_id}
      getAllDocuments(collection, query, callback, documents, projection);
    }
    else {
      callback(documents);
    }
  })
}


let songListCallback = function(list) {
  // Map songs to label and value to be displayed in the autocomplete input
  list = list.map(x => {
    let y = {}
    y["text"] = removeParentheses(x["Track Name"]) + " - " + x["Artist"]
    y["id"] = x.id
    y["name"] = x["Track Name"]
    y["artist"] = x["Artist"]
    return y;
  })

  let mc = autocomplete(document.getElementById('autocomplete'))
    .keys(list)
    .dataField("text")
    .placeHolder("Search for song or artist")
    .width(960)
    .height(200)
    .onSelected(onSelect)
    .render();

  //Call back for when user selects an option
  function onSelect(d) {
    selectedSong = d;
    console.log(d.id)
    showSongInfo(selectedSong)
  }
}

function showSongInfo(selectedSong) {    
  if(selectedSong && worldMap.spotify_countries) {
    closeMenu();

    let songEntriesCallback = function(timeLine) {

      timeLine = timeLine.filter(x => x.r != 'global')

      worldMap.spotify_countries.forEach(function(d, i) {
        let filtered = timeLine.filter(x => d == x.r);
        let aggregation = filtered.map(x => parseInt(x.s)).reduce(function(a, v) {
            return a + v;
        }, 0)
        streamsDict[d] = aggregation;
      })

      data = timeLine.map(function(x) {
        let region = "Unknown"
        if(x.r in CountryContinentDict) {
          continent = CountryContinentDict[x.r]
        }
        else {
          console.log("Problem with" + x.r)
        }
        return {
          "value": parseInt(x.s),
          "continent": continent,
          "region": x.r,
          "position": x.p,
          "date": x.d.getFullYear() + "/" + ("0" + (x.d.getMonth() + 1)).slice(-2) + "/" + ("0" + x.d.getDate()).slice(-2)
        }
      });

      
      datesArray = [];

      for(let i = 1; i < 34; i++) {
        let d = new Date(lowestDate.getTime());
        d.setDate(d.getDate() + i*7);
        datesArray.push(d.getFullYear() + "/" + ("0" + (d.getMonth() + 1)).slice(-2) + "/" + ("0" + d.getDate()).slice(-2))
      }

      timelapseData = []
      for(let j = 0; j < datesArray.length; j++) {
        timelapseData.push({"date": datesArray[j]})
      }

      for(let i = 0; i < data.length; i++) {
        let dateIdx = datesArray.indexOf(data[i].date)
        if(dateIdx > -1) {
          timelapseData[dateIdx][data[i].region] = data[i];
        }
      }

      let streamData = []
      for(let j = 0; j < datesArray.length; j++) {
        streamData.push({"date": datesArray[j]})
        for(let i = 0; i < continents.length; i++) {
          streamData[j][continents[i]] = 0
        }
      }

      for(let i = 0; i < data.length; i++) {
        let dateIdx = datesArray.indexOf(data[i].date)
        if(dateIdx > -1) {
          let region = data[i].continent
          streamData[dateIdx][region] += data[i].value
        }
      }

      let format = d3.timeParse("%Y/%m/%d");

      streamData.forEach(function(d) {
        d.date = format(d.date);
      });

      topListText
        .text(selectedSong.name + " by " + selectedSong.artist)

      let topListData = getSongYearlyTopListData(timelapseData);

      createToplist(topListData, {"country": "Country", "formatted_streams": "Streams"}, ({country, formatted_streams, position}) => ({country, formatted_streams}), "streams", false);


      console.log(streamData)
      if(streamGraph) {
        streamGraph.remove();
      }

      
      streamGraphListener = {
        buttonPressed(playing, week) {
          if(playing) {
            //console.log(JSON.stringify(timelapseData))

            startSongTimeLapse(timelapseData, week);
          } else {
            //stopSongTimeLapse();
            streamGraph.pause();
          }
        }
      }

      let rightWidth = rightDiv.clientWidth;

      streamGraph = new StreamGraph(7*rightWidth/10, 2*height/10 - 20, streamData, svgStreamGraph, streamGraphListener, continentColors, null, continents)


      streamGraph.streamGraph      
        .attr("transform", "translate(" + svgStreamGraph.node().getBoundingClientRect().width / 5 + "," +  (svgStreamGraph.node().getBoundingClientRect().height/5 + 300) + ")")

      streamGraphTransition(1000);

      setTimeout(function() {

        width = leftDiv.clientWidth;
        height = window.innerHeight ;
        if(streamGraph) {


          let rightWidth = rightDiv.clientWidth;
          streamGraph.resize(7*rightWidth/10, 2*height/10 - 20)
          streamGraphTransition(0);
        }
      }, 1000);
    

      let legend = setRankLegend(width/20, height/3, colorScales, svg);

      legend
        .attr("transform", "translate(" + 10 + ", " + (3*height/4 - legend.node().getBoundingClientRect().height/2) + ")")
    }

    getAllDocuments(db.collection('entries'), {"id":selectedSong.id}, songEntriesCallback, [], {_id: 0, s: 1, r:1, d: 1, p:1})
  }
}

client.login().then(() => getAllDocuments(db.collection('songs'), {}, songListCallback, [], {_id: 0, id: 1, "Track Name": 1, "Artist": 1}))

let count_par;
let count_list;

function setCountriesList() {
  
  count_par = d3.select("#Countries").select('p');

  count_list = count_par.append("ul").attr('id','double');

  let ordered_countries = []

  for (i in worldMap.spotify_dict){
    ordered_countries.push(worldMap.spotify_dict[i])
  };

  // Singapore and Hong-kong are too small to appear in the TopoJSON. We therefore don't let the user zoom on them.
  ordered_countries = ordered_countries.filter(x => x["alpha2"] != "sg" && x["alpha2"] != "hk");

  // Order countries alphabetically
  ordered_countries = ordered_countries.sort(function(a, b){
    if(a.name < b.name) return -1;
    if(a.name > b.name) return 1;
    return 0;
  });

  //Append countries in the list
  for(let i = 0; i < ordered_countries.length; i++) {
    count_list.append("li").attr("class","country_list").attr("id", ordered_countries[i]["alpha2"])//.style("list-style-type", "none")
    .append('a').attr('href', '#')
	.text(ordered_countries[i].name);
  }

  //d3.select("#Countries").style("overflow","scroll");
  d3.select("#Countries").style("overflow","scroll");
  d3.select("#Songs").style("overflow","auto");

  // 
  let songs_par = d3.select("#Songs").select('p');
  let songs_list = songs_par.append("ul"); 
      
      
  Object.keys(worldMap.spotify_dict).forEach(function(AlphA){
  count_list.select("#"+AlphA)
    .on("mouseover", function() { d3.select("#"+AlphA).style("font-weight", "bold")})
    .on("mouseout", function() { d3.select("#"+AlphA).style("font-weight", "inherit")})
    .on("click", function() {
      let AlphA = d3.select(this).attr('id');
      worldMap.zoom(AlphA);
      closeMenu();
    });
  });
  
}

  
let div = null;

let current_image_url;
let show_image = function(url) {
  if(url == current_image_url) {
    return;
  }

  current_image_url = url;
  d3.selectAll(".image-container").remove();

  if(url == null) {
    return;
  }

  setTimeout(function() {

    div = d3.select("#left").append("div")
      .attr("class", "image-container")
      .style("top", ((height-220)/2) + "px")
      .style("left", ((width-220)/2) + "px")
      .style("position", "absolute")
      .style("width", "220px")
      .style("height", "220px");

    let canvas = div
      .append("canvas")
      .attr("width", 220)
      .attr("height" , 220)
      .style("opacity", 0)
      .style('border-radius', '50%');

      //creer l'image 
      let image = new Image ();
      image.src = url;

      let context = canvas.node().getContext("2d");
        //fonction qui telecharge l'image
      image.onload = function() {
        // dessine l'image dans le contexte du canevas
        context.drawImage (image, 0, 0, 220, 220)    
        clipArc(context, 110, 110, 112, 2);

        function clipArc(ctx, x, y, r, f) {
            canvas.transition()
              .duration(400)
              .style("opacity", 1);

            ctx.globalCompositeOperation = 'destination-in';

            ctx.filter = "blur(12px)";  // "feather"
            ctx.beginPath();
            ctx.arc(x, y, r, 0, 2 * Math.PI);
            ctx.fill();

            // reset comp. mode and filter
            ctx.globalCompositeOperation = 'destination-in';
            ctx.filter = "none";
        }      
      }

    }, 0);

}

function removeParentheses(text) {
  try {
    text = text.replace(/ *\([^)]*\) */g, "");
    text = text.replace(/ *\[[^)]*\] */g, "");
  }
  catch(error) {
  }
  return text;
}

function setExampleSongs() {
  songs_ids = [
    "7qiZfU4dY1lWllzX7mPBI3", 
    "7KXjTSCq5nL1LoYtL7XAwS",
    "72jbDTw1piOOj770jWNeaG",
    "0KKkJNfGyhkQ5aFogxQAPU",
    "3rOSwuTsUlJp0Pu0MkN8r8",
    "6kex4EBAj0WHXDKZMEJaaF",
    "4aWmUDTfIPGksMNLV2rQP2",
    "4Km5HrUvYTaSUfiSGPJeQR",
    "3umS4y3uQDkqekNjVpiRUs",
    "2kVHAQKVtczchKctctzbtK"
  ];

  let songs_div = d3.select("#popular_songs");
  songs_list = songs_div.append("ul")
    .attr('id','single');

  for(let i = 0; i < songs_ids.length; i++) {
    id = songs_ids[i];

    let songCallback = function(data) {
      if(data[0]) {
        let song = data[0];
        let li = songs_list.append("li")
          .attr("class","country_list")
          .attr("id", song.id)
          .append('a').attr('href', '#')
          .text(removeParentheses(song["Track Name"]) + " by " + song["Artist"])

        li
          .on("mouseover", function() { li.style("font-weight", "bold")})
          .on("mouseout", function() { li.style("font-weight", "inherit")})
          .on("click", function() {
            console.log(song.id)
            song["name"] = removeParentheses(song["Track Name"])
            song["artist"] = song["Artist"]
            showSongInfo(song)
          });
      }
    }
    getAllDocuments(db.collection('songs'), {"id":id}, songCallback, [], {_id: 0, "id": 1, "Track Name": 1, "Artist": 1})


  }
}

setExampleSongs();

// Creates the tabs and selections 
let mode = 'song';
function Open(evt, Selection) {
	
	if (Selection === 'Countries') { 
    if(mode != 'country') {
      removeTopList();
      topListText.text("")
      worldMap.drawMap()
      if(streamGraph) {
        streamGraph.remove();
        streamGraph = null;
      }
      mode = 'country'; 
    }
  }
	else { 
    if(mode != 'song') {
      removeTopList();
      topListText.text("")
      show_image(null);
      if(streamGraph) {
        streamGraph.remove();
        streamGraph = null;
      }
      if(worldMap) {
        worldMap.reset();
      }
      mode = 'song'
    }
  }

	
	d3.selectAll(".tablinks").style("background-color" , "rgb(66,66,66)").style("font-weight", "").style("color", "#a8a6a6"); 
	d3.selectAll("#btn"+Selection).style("background-color" , "rgba(126, 126, 126, 0.5)").style("font-weight", "bold").style("color", "white"); 
	
	// Declare all variables
    let i, tabcontent, tablinks;
	
    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(Selection).style.display = "block";
    evt.currentTarget.className += " active";
}

//End of Nathalie's code----------------------------------------------------------------------------

function startSongTimeLapse(data, week) {

  let it = week * 20;
  week = Math.floor(week);

  let topListData = getSongTopListData(timelapseData[week]);

  createToplist(topListData, {"country": "Country", "formatted_streams": "Streams", "position": "# in country"}, ({country, formatted_streams, position}) => ({country, formatted_streams, position}), "streams");


  if(data[week] == undefined) {
    console.log(data)
  }

  function setNextTimeLapse() {
    let speed = streamGraph.timelapseSpeed;
    let delta = 1000 / speed;

    setTimeout(function() {  
      if(streamGraph.playing) {
        setNextTimeLapse();
      }
        
      streamGraph.setTimeStamp(it/20.0);
      if(it%20 == 0) {

        let topListData = getSongTopListData(data[week]);              
        updateToplist(speed, topListData, {"country": "Country", "formatted_streams": "Streams", "position": "# in country"}, ({country, formatted_streams, position}) => ({country, formatted_streams, position}), "streams", false);
  
        let countriesColors = {}

        if(data[week]) {
          for(let i = 0; i < worldMap.spotify_countries.length; i++) {
            let region = worldMap.spotify_countries[i];
            if(region in data[week]) {
              
              let position = data[week][region].position;
              /*let shade = (100 - position) * 255 / 99.0;
              countriesColors[region] = d3.color(d3.rgb(shade, shade/2, shade/2))*/

              countriesColors[region] = colorScales[CountryContinentDict[region]]((position-1)/99.0)            
              //countriesColors[region] = colorScale(position/100.0)

            }
          }
        }
        else {
          streamGraph.pause()
          //stopSongTimeLapse();
        }
        worldMap.drawMap(countriesColors, delta);

        week += 1;
        if(week == data.length) {
          streamGraph.pause();
          //stopSongTimeLapse();
        }
      }
      it++;
    }, delta/20.0);
  }

  setNextTimeLapse();
}

function displayTopArtistImage(id) {
  let imageCallback = function(data) {
    console.log(data[0].image);
    show_image(data[0].image)
  }
  getAllDocuments(db.collection('songs'), {"id":id}, imageCallback, [], {_id: 0, "image": 1})
}

function startCountryTimeLapse(data, week) {

  let it = week * 20;
  week = Math.floor(week);

  let speed = streamGraph.timelapseSpeed;

  console.log(week)
  console.log(data)
  let topListData = getCountryTopListData(data[week]);
  console.log(topListData)

  updateToplist(speed, topListData, {"c_position": "#", "c_song": "Song", "c_formatted_streams": "Streams"}, ({c_position, c_song, c_formatted_streams}) => ({c_position, c_song, c_formatted_streams}), "streams", true);

  displayTopArtistImage(topListData[0].id)

  if(data[week] == undefined) {
    console.log(data)
  }

  function setNextTimeLapse() {
    let speed = streamGraph.timelapseSpeed;
    let delta = 1000 / speed;

    setTimeout(function() {  
      if(streamGraph.playing) {
        setNextTimeLapse();
      }

      streamGraph.setTimeStamp(it/20.0);
      if(it%20 == 0) {

        let topListData = getCountryTopListData(data[week]);
          
        updateToplist(speed, topListData, {"c_position": "#", "c_song": "Song", "c_formatted_streams": "Streams"}, ({c_position, c_song, c_formatted_streams}) => ({c_position, c_song, c_formatted_streams}), "streams", true);

        console.log(topListData[0].id);

        displayTopArtistImage(topListData[0].id)

        week += 1;
        if(week == data.length) {
          streamGraph.pause();
        }
      }
      it++;
    }, delta/20.0);
  }

  setNextTimeLapse();
  playing = true;
}

function resize() {
  width = leftDiv.clientWidth;
  height = window.innerHeight ;


  d3.select("svg")
    .attr("width", width)
    .attr("height", height)

  worldMap.resize(width, height)

  if(streamGraph) {


    let rightWidth = rightDiv.clientWidth;
    streamGraph.resize(7*rightWidth/10, 2*height/10 - 20)
    streamGraphTransition(0);
  }

  if(div) {
    div
      .style("top", ((height-220)/2) + "px")
      .style("left", ((width-220)/2) + "px")
  }
} 

window.addEventListener("resize", resize);

d3.select(self.frameElement).style("height", height + "px");

let style = getComputedStyle(document.body);
let row_size = +style.getPropertyValue('--main-row-size') + 4;
let data_row_size = row_size - 2;

let spotify_green = style.getPropertyValue('--main-spotify-green');
let triangle_width = 13;
let triangle_height = 13;
let indexx = 1;
let uniqueID = 0;
let testDataset = [];

		
function parseFeatures(features){
  let temp = JSON.parse(JSON.stringify(features));
  let temp2 = {};
  temp2['axes'] = JSON.parse(JSON.stringify(d3.entries(temp)).replace(/key/g, "axis"));

  return [temp2];
}

// Define the div for the tooltip
let div_toplist = d3.select("body").append("div")	
    .attr("class", "song_tooltip")				
    .style("opacity", 0);

let tip = d3.tip().attr('class', 'd3-tip').offset([20, -330]).html("<div class='radar'></div>");

// Create a local variable for storing previous data.
let previousData = d3.local();

function removeTopList() {
  d3.select(".table").remove();
}
// toplistData - list of json-like elements
function createToplist(toplistData, keys, filter, sortBy, info = false){  
  removeTopList();

  toplistData = toplistData.sort(function(a, b){
      if(+a[sortBy] < +b[sortBy]) return 1;
      if(+a[sortBy] > +b[sortBy]) return -1;
      return 0;
  });

  toplistData = toplistData.slice(0,15);

  //console.log(JSON.stringify(toplistData));

  //var keyValues = d3.keys(toplistData[0]);
  //let keys = {"p": "#","n": "Title", "a": "Artist", "s": "Streams"};
  let head = rankPage
      .append("div")
      .attr("class", "table")
      .style("margin-left", "10px")
      .append("div")
      .attr("class", "headers")
      //.style("height", data_row_size + "px");

  console.log(d3.entries(keys))

  head.selectAll("div.header")
      .data(d3.entries(keys))
      .enter()
      .append("div")
      .attr("class", "header")
      .attr("cell_type", (d) => {return d.key;})        
      .html((d, i) => {return d.value;});


  let data_rows = d3.select("div.table").selectAll("div.datarow")
      .data(toplistData, (d) => {return d.id;})
      .enter()
      .append("div")
      .attr("class", "datarow")
      .attr("id", function(d) { return uniqueID++; })
      .style("height", data_row_size + "px")
      .style("top", (d,i) => {return (row_size + ((i) * row_size)) + "px";});

  data_rows.selectAll("div.data")
      .data((d) => { return d3.entries(filter(d));})
      .enter()
      .append("div")
      .attr("class", "data")
      .attr("cell_type", (d) => {return d.key;})
      .html((d) => {return d.value;});

  if(info) {

    let info_image = data_rows
      .append("div")
        .attr("class", "info")
        .style("height", data_row_size + "px")
        .style("width", data_row_size + "px")
      .append("svg")
        .attr("width", 24 + "px")
        .attr("height", 24 + "px")
        .attr("class", "info")
      .append("image")
        .attr("xlink:href","img/info_icon.png")
        .attr("width", 24 + "px")
        .attr("height", 24 + "px")
        .on('mouseover', function(d) {     
          d3.select(".d3-tip").transition().style("opacity", "1");   
          tip.show(d);             
          let radarCallback = function(features) {
            //console.log(features)
            if(features[0]) {
              let svg_radar2 = RadarChart(".radar", parseFeatures(features[0]), radarChartOptions2);
            }
          }

          getAllDocuments(db.collection('songs'), {"id":d.id}, radarCallback, [], {_id: 0, "acousticness": 1, "danceability": 1, "energy": 1, "instrumentalness": 1, "liveness": 1, "speechiness": 1, "valence": 1})

        })
        .on('mouseout', function(d) {
          d3.select(".d3-tip").transition().duration(1000).style("opacity", "0").on("end", () => {d3.select("svg.radar").remove(); tip.hide;});
          
        });
        /* .on("mouseover", function(d) {		
            div_toplist.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div_toplist	
                .style("left", (d3.event.pageX + 10) + "px")		
                .style("top", (d3.event.pageY - 10) + "px");

            let svg_radar2 = RadarChart(".song_tooltip", data_radar, radarChartOptions2);
          })					
        .on("mouseout", function(d) {		
            div_toplist.transition()		
                .duration(500)		
                .style("opacity", 0);}) */
    info_image.call(tip);

    d3.select(".d3-tip")
        .on('mouseover', function(d) { d3.select(".d3-tip").transition().style("opacity", "1");})
        .on('mouseout', function(d) {d3.select(".d3-tip").transition().duration(1000).style("opacity", "0")
            .on("end", () => {d3.select("svg.radar").remove(); tip.hide;}); });
  }

  //data_rows.on("click", showDetails);

  d3.selectAll("[cell_type = p]")
      .each(function(d) { previousData.set(this, d.value) });
}    

function transitionSheet() {
    d3.selectAll("div.datarow")
    .transition()
    .duration(2000)
    .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size)) + "px";});
    }

function sortSheet() {
    var dataset = d3.selectAll("div.datarow").data();
    dataset.sort((a,b) => {return a.p > b.p;
        });

    d3.selectAll("div.datarow")
    .data(dataset, (d) => {return d.title;})
    .transition()
    .duration(2000)
    .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size));});
    }   


function getSongTopListData(weekData) {
  let temp = [];
  for(key in weekData) {
    if(key != "date") {
      temp.push(weekData[key])
    }
  }

  let topListData = [];
  temp.forEach(x => {
    let entry = {};
    if(worldMap.spotify_dict[x.region]) {
      entry["country"] = worldMap.spotify_dict[x.region].name;
      entry["id"] = worldMap.spotify_dict[x.region].id;
      entry["streams"] = x.value;
      entry["position"] = x.position;
      entry["formatted_streams"] = nFormatter(x.value, 3);
      topListData.push(entry);
    } else {
      console.log("Problem with " + x.region)
    }
  });

  return topListData;
}

function getSongYearlyTopListData(data) {
  let temp = [];

  for(key in worldMap.spotify_dict) {
    if(key != "date") {
      let x = {}
      x["region"] = key;
      x["value"] = data.reduce(function(a, v) {
                      if(key in v) {
                        return a + v[key].value;
                      } else {
                        return a;
                      }
                    }, 0)

      temp.push(x)
    }
  }

  let topListData = [];
  temp.forEach(x => {
    let entry = {};
    if(worldMap.spotify_dict[x.region]) {
      entry["country"] = worldMap.spotify_dict[x.region].name;
      entry["id"] = worldMap.spotify_dict[x.region].id;
      entry["streams"] = x.value;
      entry["position"] = x["avg_position"];
      entry["formatted_streams"] = nFormatter(x.value, 3);
      topListData.push(entry);
    } else {
      console.log("Problem with " + x.region)
    }
  });

  return topListData;
}

function getCountryTopListData(weekData) {

  let temp = [];
  for(key in weekData) {
    if(key != "date") {
      temp.push(weekData[key])
    }
  }

  let topListData = [];
  temp.forEach(x => {
    let entry = {};
    entry["c_position"] = x.position;
    entry["c_song"] = x.song
    entry["id"] = x.id;
    entry["streams"] = x.value;
    entry["c_formatted_streams"] = nFormatter(x.value, 3);
    entry["artist"] = x.artist;

    topListData.push(entry);
  });

  return topListData;
}

function getCountryYearlyTopListData(data) {

  let songDict = {}
  data.forEach(x => {
    for(key in x) {
      songDict[key] = x[key].id;
    }
  });

  let temp = [];

  for(key in songDict) {
    if(key != "date") {
      let x = {}
      x["id"] = songDict[key]
      x["song"] = key;
      x["value"] = data.reduce(function(a, v) {
                      if(key in v) {
                        return a + v[key].value;
                      } else {
                        return a;
                      }
                    }, 0)

      temp.push(x)
    }
  }

  let topListData = [];
  temp.forEach(x => {
    let entry = {};

    entry["c_song"] = x.song;
    entry["id"] = x.id;
    entry["streams"] = x.value;
    entry["c_formatted_streams"] = nFormatter(x.value, 3);
    topListData.push(entry);      
  });

  topListData = topListData.sort(function(a, b){
    if(+a["streams"] < +b["streams"]) return 1;
    if(+a["streams"] > +b["streams"]) return -1;
    return 0;
  });

  topListData = topListData.map(function(x, i) {
    x["c_position"] = i+1;
    return x;
  })

  return topListData;

}

function updateToplist(speed, newToplist, keys, filter, sortBy, info = false){ 
    speed = Math.max(speed, 0.35)

    newToplist = newToplist.sort(function(a, b){
      if(+a[sortBy] < +b[sortBy]) return 1;
      if(+a[sortBy] > +b[sortBy]) return -1;
      return 0;
    });

    newToplist = newToplist.slice(0,15);

    newToplist = newToplist.map(function(d, i) {
      d["value"] = i;
      return d;
    })

    //console.log(newToplist);

    // Update those that are in the table
    let rows = d3.select("div.table")
        .selectAll("div.datarow")
        .data(newToplist, (d) => {return d.id;})
        .call(savePreviousData)
        .attr("is_new", "update");
    
    let cells = rows.selectAll("div.data")
        .data((d) => {return d3.entries(filter(d));})
        .html((d) => {return d.value;})
        .attr("is_new", "update");

    rows.transition("sorting")
        .delay((d, i) => {return 100 + (i/newToplist.length) * 400/speed;})
        .duration(400/speed)
        .style("top", (d,i) => {return (row_size + ((i) * row_size)) + "px";})
        .on("start", addTriangle);

    // Add new ones
    let enterRows = rows.enter()
        .append("div")
        .attr("class", "datarow")
        .attr("id", function(d) { return uniqueID++; })
        .style("top", (d,i) => {return (row_size + ((i) * row_size)) + "px";})
        .style("opacity", 0.0)
        .style("left", "-600px")
        .style("height", data_row_size + "px")
        .attr("is_new", "enter");
        //.on("click", showDetails);

    if(info) {
      let enter_info = enterRows
        .append("div")
        .attr("class", "info")
        .style("height", data_row_size + "px")
        .style("width", data_row_size + "px")
      .append("svg")
        .attr("width", 24 + "px")
        .attr("height", 24 + "px")
      .append("image")
        .attr("xlink:href","img/info_icon.png")
        .attr("width", 24 + "px")
        .attr("height", 24 + "px")
        .on('mouseover', function(d) {     
            d3.select(".d3-tip").transition().style("opacity", "1");   
            tip.show(d);
            let radarCallback = function(features) {
              //console.log(features)
              if(features[0]){
                let svg_radar2 = RadarChart(".radar", parseFeatures(features[0]), radarChartOptions2);
              }
            }

          getAllDocuments(db.collection('songs'), {"id":d.id}, radarCallback, [], {_id: 0, "acousticness": 1, "danceability": 1, "energy": 1, "instrumentalness": 1, "liveness": 1, "speechiness": 1, "valence": 1})                   
        })
        .on('mouseout', function(d) {
          d3.select(".d3-tip").transition().duration(200/speed).style("opacity", "0").on("end", () => {d3.select("svg.radar").remove(); tip.hide;});
          
        });

        enter_info.call(tip);
    }

    let enterCells = enterRows.selectAll("div.data")
        .data((d) => {return d3.entries(filter(d));})
        .enter()
        .append("div")
        .attr("class", "data")
        .attr("cell_type", (d) => {return d.key;})
        .html((d) => {return d.value;});
    
    enterRows.transition("new_rows")
        .ease(d3.easeQuad)
        .delay(600/speed)
        .duration(200/speed)
        .style('opacity', 1.0)
        .style("left", "0px");

    rows.exit()
        .attr('is_new', 'exit')
        .transition("exit_rows")
        .ease(d3.easeQuad) //"quad" d3.v3
        .delay(0)
        .duration(200/speed)
        .style('opacity', 0.0)
        .style("left", "600px")
        .remove();
}                   
function addTriangle() {

    d3.select(this).selectAll("[cell_type = p]")
        .append('svg')
        .attr("class", "triangle")
        .attr("height", triangle_height + "px")
        .attr("width", triangle_width + "px")
        .style("right", 0 + 'px')
            .append('polygon')
            .attr('points', function(d) {
                console.log(+previousData.get(this));
                console.log(+d.value);                    
                var diff = +previousData.get(this) - d.value;  // Retrieve previously stored data.               
                return diff < 0 ? "0,0 " + triangle_width + ",0 " + triangle_width/2 +"," + triangle_height + " 0,0" : 
                        diff > 0 ? "0," + triangle_height +" " + triangle_height+","+triangle_width+" "+triangle_width/2+",0 0,"+triangle_height :
                        "0," + triangle_height/2 + " " + triangle_width+","+triangle_width/2+" 0," + triangle_width/2;
                })
            .style("fill" ,function(d) {
                var diff = +previousData.get(this) - d.value; 
                return diff < 0 ? "red" : diff > 0 ? "green" : "black";
                })
            .style("stroke" ,function(d) {
                var diff = +previousData.get(this) - d.value; 
                return diff === 0 ? "black" : "";
                })
            .style("opacity", 0)
            .transition()
            .duration(1000)
            .ease(d3.easeLinear)
            .style("opacity", 1);
}
function savePreviousData() {
    d3.selectAll("[cell_type = p]").each(function(d) { console.log(this); previousData.set(this, d.value) });
}
function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}


function showDetails()
{
    let movingRows = d3.selectAll("div.datarow")
        .filter((d) => d.p > d3.select(this).datum().p);

    let movingRowsNodes = movingRows.nodes();

    movingRows.transition()
        .duration(1000)
        .style("top", (d, i) => { return +d3.select(movingRowsNodes[i]).style("top").slice(0,-2) + 30 + "px"});
}


/*
d3.select("#controls").insert("button", ".table").on("click", sortSheet).html("sort")
d3.select("#controls").insert("button", ".table").on("click", transitionSheet).html("transition")
d3.select("#controls").insert("button", ".table").on("click", transformData).html("transform")
*/

//////////////////////////////////////////////////////////////
//////////////////////// Set-Up //////////////////////////////
//////////////////////////////////////////////////////////////

var margin_radar = { top: 30, right: 40, bottom: 30, left: 40 },
width_radar = +style.getPropertyValue('--tooltip-song-size') + 60 - margin_radar.left - margin_radar.right,
height_radar = +style.getPropertyValue('--tooltip-song-size') - margin_radar.top - margin_radar.bottom;
resize();



var radarChartOptions2 = {
  w: width_radar,
  h: height_radar,
  margin: margin_radar,
  maxValue: 1,
  levels: 5,
  roundStrokes: false,
  color: d3.scaleOrdinal().range(["#AFC52F", "#ff6600"]),
  format: '.2f',
  opacityArea: 0.35,
  opacityCircles: 0.01,
  wrapWidth: 100,
  //legend: { title: 'Organization XYZ', translateX: 100, translateY: 40 },
  //unit: '$'
};

// Draw the chart, get a reference the created svg element :
//let svg_radar2 = RadarChart(div_toplist, data_radar, radarChartOptions2);
</script>