<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Music is uncountable</title>
  <!--
  <link rel="stylesheet" href="complete/awesomplete.css" /> 
  <script src="complete/awesomplete.js" async></script>-->
  <script type="text/javascript" src="complete/autocomplete.js"></script>
  <link rel="stylesheet" href="complete/autocomplete.css"/>
</head>

<style>

:root {
    --main-row-size: 24;
    --main-font-size: 12;
    --tooltip-song-size: 250;
}

body {
    overflow: hidden;
    width: 100%;
    font-family: 'Roboto', sans-serif;
    font-size: var(--main-font-size);
}

div.data {
  position: absolute;
  padding: 4px 0px;
  height: 100%;
  overflow:hidden;
  display:inline-block;
  text-overflow: ellipsis;
  white-space: nowrap;
  margin-left: auto;
  margin-right: auto;
  vertical-align: middle;
  }

div.headers {
  position: absolute;
  width: calc(29vw - 12px);
  border: 2px rgba(75, 75, 75, 0.5);
  border-style: solid;
  border-radius: 5px;
  height: var(--main-row-size);
}

div.datarow {
  position: absolute;
  width: calc(29vw - 12px);
  border: 1px rgba(0, 0, 0, 0.51) solid;
  border-radius: 5px;
  background: rgba(126, 126, 126, 0.5);
  height: var(--main-row-size);
  text-align: left;
}

div.table-container {
    position: absolute;
    /*overflow: scroll;*/
    overflow: hidden;
    width: 30vw;
}

div[cell_type="p"] {
/*     display: inline-block; */ 
    color: rgb(188, 188, 188);
    left: 0%;
    width: 35px;
    text-align: right;
    margin-left: 5px; 
    display: flex;    
}
div[cell_type="position"] {
/*     display: inline-block; */ 
    color: rgb(188, 188, 188);
    right: 0px;
    width: 120px;
    text-align: left;
    margin-left: 0px; 
}


div[cell_type="country"] {
    color: rgb(188, 188, 188);
    left: 0%;
    width: calc(50% - 5px);
    margin-left: 5px;
}


div[cell_type="formatted_streams"] {
    color: rgb(188, 188, 188);
    width: 100px;
    left: 40%;
}

div[cell_type="n"] {
    color: rgb(188, 188, 188);
    left: 10%;
    width: calc(40% - 5px);
}

div[cell_type="a"] {
    color: rgb(188, 188, 188);
    left: 50%;
    width: calc(50% - 105px);
}

div[cell_type="s"] {
    color: rgb(188, 188, 188);
    right: 0;
    width: 100px;
}

div.info {
  position: absolute;
  right: 0px;
  opacity: 1;
  z-index: 1;	
  display: flex;
  align-items: center;
}

div.header {
  position: absolute;
  padding: 0 0px;
  overflow: hidden;
  margin-left: 0px;
}

div.header[cell_type="p"] {
  position: absolute;
  padding: 0 0px;
  overflow: hidden;
  margin-left: 5px;
  width: 10%;
}

div.header[cell_type="position"] {
  position: absolute;
  padding: 0 0px;
  overflow: hidden;
  margin-left: 0px; 
  width: 120px;    
  right: 0px;    
  text-align: left;
}


image {
/*   z-index: 999;
 */}

div[is_new="enter"] {
    background-color: rgba(255, 255, 96, 0.5);
    
}

div.table {
  position:relative;
  left: 0px;
  width: calc(30vw - 12px);
}

svg.triangle {
    position: absolute;
   /* width: 20px;
    height: 20px; */
    top: 6px;
    right: 0px;
    opacity: 0.5;
    margin: 0 auto;
    display: block;
}

svg.radar {
  z-index : 3;
}

svg.info {
  margin: 0 auto;
  display: block;
}

div.song_tooltip {	
    position: absolute;			
    text-align: center;			
    width: var(--tooltip-song-size);					
    height: var(--tooltip-song-size);	;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: rgba(116, 116, 116, 0.496);	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;
    z-index: 2;	
    display: inline-flex;	
}


/* .table-container::-webkit-scrollbar {
  width: 10px;
  background-color: rgba(0, 0, 0, 0.667);
}

.table-container::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 5px;
} */

.table-container::-webkit-scrollbar-track
{
	-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
	border-radius: 10px;
	background-color: rgba(245, 245, 245, 0.503);
}

.table-container::-webkit-scrollbar
{
	width: 12px;
	background-color: rgba(245, 245, 245, 0);
}

.table-container::-webkit-scrollbar-thumb
{
	border-radius: 10px;
	-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);
	background-color: #555;
}

.d3-tip {
  line-height: 1;
  font-weight: 300;
  padding: 3px;
  background: rgba(145, 145, 145, 0.509);
  /* color: #fff; */
  border-radius: 2px;
  pointer-events: none;
  text-align: center;
  text-shadow: 0 1px 0 rgba(255, 255, 255, 0.53), 1px 0 0 rgba(255, 255, 255, 0.53), -1px 0 0 rgba(255, 255, 255, 0.53), 0 -1px 0 rgba(255, 255, 255, 0.53);
  cursor: default;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 80%;
  line-height: 1;
  /* color: rgba(145, 141, 141, 0.503); */
  position: absolute;
  pointer-events: none;
}

/* Eastward tooltips */
.d3-tip.e:after {
  content: "\25C0";
/*   margin: -4px 0 0 0;
 */  top: 10%;
     /* left: -8px; */
}

text.axisLabel {
  fill: #262626 !important;
}


/* Style the buttons inside the tab */
div.tab button {
    background-color: inherit;
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 14px 16px;
    transition: 0.3s;
}

#btnSongs{
	background-color: #ccc;
}

#btnCountries{
  background-color: #eee;
}

/* Change background color of buttons on hover */
div.tab button:hover {
    background-color: #ddd;
}


/* Create an active/current tablink class */
div.tab button.active {
    background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
  font-family: 'Titillium Web', sans-serif;
	/*font-family : Roboto;*/
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: none;
  color: #626262;
	/*color: white;*/
}

.container {
  overflow: hidden;
}
.container > div[class^="column"] {
  border-left: 2px solid #C2C7C9;
  border-right: 2px solid #C2C7C9;
}
.container div[class^="column"]:first-child {
  border-left: none;
}
.container div[class^="column"]:last-child {
  border-right: none;
}

</style>

<body style="margin: 0; background: #222222">
  <nav class="main-menu" style="width: 400px; right:0;">
    <div class="menu-content">
      <div class="tab" style = "height:10vh;">
        <button id = "btnSongs" class="tablinks" onclick="Open(event, 'Songs')" style = "height:10vh; width: 50%;">Songs</button>
        <button id = "btnCountries" class="tablinks" onclick="Open(event, 'Countries')" style = "height:10vh; width: 50%;">Countries</button>
      </div>

      <div id="Songs" class="tabcontent" style = "height:90vh;">
        <h3>Search and select a song !</h3>
        <div id="autocomplete"></div>
        <!--
        <input id="song_input" hidden="true" class="awesomplete"/> -->
        <button id="go_button" hidden="true">Show infos</button>
        <p>  </p>
      </div>

      <div id="Countries" class="tabcontent" style = "height:90vh;  overflow:scroll;">
        <h3>Click on the map or on the list below to select a country!</h3>
        <p></p> 
      </div>
    </div>
  </nav>

  <div id="container" class="container" style="width:100%; margin: 0px;">                                   
    <div id="left" class="column" style="float:left; width:65vw; margin: 0px; height:100vh;"> 
    </div>                     
    <div id="right" class="column" style="float:right; width:35vw; margin: 0px; height:100vh;"> 
	 </div>      
	 <div id="controls" ></div>	
  </div>   
</body>

<!--<link href="https://fonts.googleapis.com/css?family=Indie+Flower" type="text/css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">-->
<link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">

<link rel="stylesheet" type="text/css" href="music.css">



<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="js/utils.js"></script>
<script src="https://s3.amazonaws.com/stitch-sdks/js/library/stable/stitch.min.js"></script>
<link rel="stylesheet" href="css/streamgraph.css"></script>
<script src="js/streamgraph.js"></script>
<link rel="stylesheet" href="css/ranklegend.css"></script>
<script src="js/ranklegend.js"></script>
<script src="js/worldmap.js"></script>
<!--<script src="stitch.js"></script>-->
<script src="radarChart.js"></script>	
<script src="tip.js"></script>
<script>



let timer;

let leftDiv = document.getElementById("left");

let width = leftDiv.clientWidth;
let height = window.innerHeight ;

let menu = d3.select(".main-menu")
let menuContent = d3.select(".menu-content")

menu.on("mouseenter", function(d) {
    menu.transition()
      .duration(400)
      .style("width", "400px")
    menuContent
      .style("display", "initial")
  })

menu.on("mouseleave", function(d) {
    menuContent.style("display", "none")
    menu.transition()
      .duration(250)
      .style("width", "36px")
  })

/*
map.append("use")
    .attr("class", "fill")
    .attr("xlink:href", "#sphere");*/
/*
map.append("rect")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("fill", d3.color("#00FFFFFF"));*/


let countryTooltip = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);

let streamGraph;
let timelapseData;


const client = new stitch.StitchClient('dataviz-xeqhx');
const db = client.service('mongodb', 'mongodb-atlas').db('music');


const continents = ["Europe","North America","Latin America"/*"South America", "Central America"*/, "Asia & Oceania"/* "Asia","Oceania"*/]

const NorthAmerica = ["us","ca"];
const CentralAmerica = ["do","pa","mx","cr","gt","sv","hn"];
const SouthAmerica = ["ar","br","ec","bo","uy","cl","py","pe","co"];
const LatinAmerica = CentralAmerica.concat(SouthAmerica);
const Asia = ["jp","ph","id","my","sg","hk","tw"];
const Europe = ["se","hu","pl","be","gr","es","fi","at","ch","sk","gb","pt","is","de","fr","it","nl","cz","cy","dk","ie","ee","lt","no","tr","lv"];
const Oceania = ["au","nz"];
const AsiaOceania = Asia.concat(Oceania);

//const continentColors = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6"];
//const continentColors = ["#3377ff", "#ff5a33", "#ffad33", "#33ff3f", "#990099", "#0099c6"];
const continentColors = ["#295fcc", "#cc4829", "#cc8a29", "#29cc33", "#990099", "#0099c6"];
const continentColorsDict = {
  "Europe": continentColors[0],
  "North America": continentColors[1],
  "Latin America": continentColors[2],
  "Asia & Oceania": continentColors[3]
}


let CountryContinentDict = {};
for(let i = 0; i < NorthAmerica.length; i++) {
  CountryContinentDict[NorthAmerica[i]] = "North America"
}
for(let i = 0; i < CentralAmerica.length; i++) {
  CountryContinentDict[CentralAmerica[i]] = "Central America"
}
for(let i = 0; i < SouthAmerica.length; i++) {
  CountryContinentDict[SouthAmerica[i]] = "South America"
} 
for(let i = 0; i < LatinAmerica.length; i++) {
  CountryContinentDict[LatinAmerica[i]] = "Latin America"
} 
for(let i = 0; i < Europe.length; i++) {
  CountryContinentDict[Europe[i]] = "Europe"
}
for(let i = 0; i < Asia.length; i++) {
  CountryContinentDict[Asia[i]] = "Asia"
}
for(let i = 0; i < Oceania.length; i++) {
  CountryContinentDict[Oceania[i]] = "Oceania"
}
for(let i = 0; i < AsiaOceania.length; i++) {
  CountryContinentDict[AsiaOceania[i]] = "Asia & Oceania"
}


let colorScale = d3.scaleLinear()
    .domain([0,1])
    //.interpolate(d3.interpolateHcl)
    .interpolate(d3.interpolateRgb)
    .range([d3.rgb('#FF4444'), d3.rgb("#444444")]);

let colorScales = {
}

for(let continent in continentColorsDict) {
  colorScales[continent] =  d3.scaleLinear()
                              .domain([0,0.2,1])
                              //.interpolate(d3.interpolateHcl)
                              .interpolate(d3.interpolateRgb)
                              .range([d3.rgb(continentColorsDict[continent]), d3.interpolateRgb(d3.rgb(continentColorsDict[continent]),"#666")(0.5), d3.rgb("#666")]);
}


let svg = d3.select("#left").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("transform", "translate(" + 0 + "," + 0 + ")");



let worldDataReadyCallback = function() {
  setCountriesList();

}


let zoomCallback = function(alpha) {
  let countryInfoCallback = function(timeLine) {

  }

  getAllDocuments(db.collection('entries'), {"r":alpha}, countryInfoCallback, [], {_id: 0, s: 1, r:1, d: 1, p:1})
}

let worldMap = new WorldMap(width, height, svg, continentColorsDict, CountryContinentDict, worldDataReadyCallback, zoomCallback);

let streamPage = d3.select("#right").append("div")
  .attr("class", "table-container")
  .style("width", "calc(35vw - 46px)")
  .style("height", "30%")


streamPage
    .style("bottom", 0 + "px")
    .style("right", 36 + "px")


let rankPage = d3.select("#right").append("div")
    .attr("class", "table-container")
    .style("align-items", "center")
    .style("margin-left", "10px")
    .style("width", "calc(35vw - 46px)")
    .style("height", "70%")

let svgStreamGraph = streamPage.append("svg")

svgStreamGraph
  .attr("width","100%")
  .attr("height", "100%")

  /*
svgStreamGraph
    .attr("transform", "translate(" + 0 + "," + (7*svgStreamGraph.height()/10)+ ")");*/

let topListText = rankPage.append("h2")
  .text("")
  .style("margin", "10px")
  .style("width", "calc(100% - 36px)")
  .style("text-align", "center")
  .style("color", "white")



rankPage
    .style("top", 0 + "px")
    .style("right", 36 + "px")
/*
    .attr("class", "node")
    .attr("width", width)
    .attr("height", height)
    .attr("x", 0)
    .attr("y", 0)
    .style("width", width + "px")
    .style("height", height + "px");*/

/*
let navigationMap = true;


let navigation = svg.append("image")
    .attr("xlink:href","img/semi.svg")
    .attr("width", width/15)
    .attr("height", width/30)

navigation
  .attr("transform", "translate(" + ((width/2)-(navigation.node().getBoundingClientRect().width / 2)) + "," + (height - navigation.node().getBoundingClientRect().height) + ")");



function getNavigationTransform() {
    if(navigationMap) {
      return "translate(" + ((width/2)-(navigation.node().getBoundingClientRect().width / 2)) + "," + (height - navigation.node().getBoundingClientRect().height) + ") rotate(0)";
    } else {
      return "translate(" + ((width/2)+(navigation.node().getBoundingClientRect().width / 2)) + "," +  navigation.node().getBoundingClientRect().height + ") rotate(180)"
    }
}

navigation.on("click", function() {

    if(navigationMap) { 

      navigationMap = false

      navigation.transition()
        .attr("transform", getNavigationTransform())
        .duration(1000) 
        .delay(0)    

      worldMap.map.transition()
        .attr("transform", "translate(0, " + (-height) + ")")
        .duration(1000) 
        .delay(0)    

        let streamGraph_height = 50;

        if(streamGraph) {
            streamGraph_height = streamGraph.streamGraph.node().getBoundingClientRect().height;
        }

      rankPage.transition()
        .style("top", (navigation.node().getBoundingClientRect().height + streamGraph_height + 20) + "px")
        .duration(1000) 
        .delay(0)    

    } 
    else {
      navigationMap = true

      navigation.transition()        
        .attr("transform", getNavigationTransform())
        .duration(1200) 
        .delay(0)   

      worldMap.map.transition()
        .attr("transform", "translate(0, " + 0 + ")")
        .duration(1200) 
        .delay(0)     

      rankPage.transition()
        .style("top", (height + 10) + "px")
        .duration(1000) 
        .delay(0)   
    }


    streamGraphTransition(1000);
  })
*/
function streamGraphTransition(delay) {
/*
  if(streamGraph) {   
    if(navigationMap) {
      */

/*
      streamGraph.streamGraph.transition()
        .attr("transform", "translate(" + (width-(streamGraph.streamGraph.node().getBoundingClientRect().width - 10)) + "," + (height  - streamGraph.streamGraph.node().getBoundingClientRect().height) + ")")
        .duration(delay) 
        .delay(0)  */ 


      streamGraph.streamGraph.transition()
        .attr("transform", "translate(" + svgStreamGraph.node().getBoundingClientRect().width / 5 + "," +  svgStreamGraph.node().getBoundingClientRect().height/5 + ")")
        .duration(delay) 
        .delay(0)   

  /*  }
    else {   
      streamGraph.streamGraph.transition()
        .attr("transform", "translate(" + (width-streamGraph.streamGraph.node().getBoundingClientRect().width) + "," + (navigation.node().getBoundingClientRect().height + 10) + ")")
        .duration(delay) 
        .delay(0)   
    }
  }*/
}


const lowestDate = new Date("2017-01-01T12:00:00.000Z");
let midDate = new Date("2017-07-01T00:00:00.000Z");
let selectedSong;

let streamsDict = {};

function linspace(start, end, n) {
    var out = [];
    var delta = (end - start) / (n - 1);

    var i = 0;
    while(i < (n - 1)) {
        out.push(start + (i * delta));
        i++;
    }

    out.push(end);
    return out;
}



let getAllDocuments = function(collection, query, callback, documents, projection) {
  //console.log(query)
  //console.log(projection)
  collection.find(query,{project: projection, limit:10000}).then(items => {
    documents = documents.concat(items);
    
    if(items.length >= 10000) {
      let last_id = documents[documents.length - 1]["_id"];
      query["_id"] = {"$gt":last_id}
      getAllDocuments(collection, query, callback, documents, projection);
    }
    else {
      callback(documents);
    }
  })
}


let songListCallback = function(list) {
  // Map songs to label and value to be displayed in the autocomplete input
  songsList = list.map(function(x) {
    return {
      label: x["Track Name"] + " - " + x["Artist"], 
      value: { text: x["Track Name"], id: x["id"] }
    }
  });


/*

  // Set the autocomplete input
  let input = document.getElementById("song_input");
  new Awesomplete(input, {
    list: songsList, 
    replace: function(item) {
      selectedSongID = item.value.id;
      this.input.value = item.value.text;
    }
  });


  // Display the autocomplete input
  input.hidden = false;
*/

  //Variable to hold autocomplete options


list = list.map(x => {
  let y = {}
  y["text"] = x["Track Name"] + " - " + x["Artist"]
  y["id"] = x.id
  y["name"] = x["Track Name"]
  y["artist"] = x["Artist"]
  return y;
})

let mc = autocomplete(document.getElementById('autocomplete'))
        .keys(list)
        .dataField("text")
        .placeHolder("Search for song or artist")
        .width(960)
        .height(500)
        .onSelected(onSelect)
        .render();

  //Call back for when user selects an option
  function onSelect(d) {
    selectedSong = d;
    console.log(d.id)
  }

  let button = document.getElementById("go_button");
  button.hidden = false;
  button.onclick = function() {    
    if(selectedSong && worldMap.spotify_countries) {
      let songEntriesCallback = function(timeLine) {
        timeLine = timeLine.filter(x => x.r != 'global')

        worldMap.spotify_countries.forEach(function(d, i) {
          let filtered = timeLine.filter(x => d == x.r);
          let aggregation = filtered.map(x => parseInt(x.s)).reduce(function(a, v) {
              return a + v;
          }, 0)
          streamsDict[d] = aggregation;
        })

        data = timeLine.map(function(x) {
          let region = "Unknown"
          if(x.r in CountryContinentDict) {
            continent = CountryContinentDict[x.r]
          }
          else {
            console.log("Problem with" + x.r)
          }
          return {
            "value": parseInt(x.s),
            "continent": continent,
            "region": x.r,
            "position": x.p,
            "date": x.d.getFullYear() + "/" + ("0" + (x.d.getMonth() + 1)).slice(-2) + "/" + ("0" + x.d.getDate()).slice(-2)
          }
        });

        
        regionsArray = ["Europe","North America","Latin America"/*"South America", "Central America"*/, "Asia & Oceania"/*"Asia","Oceania"*/]
        datesArray = [];

        for(let i = 1; i < 34; i++) {
          let d = new Date(lowestDate.getTime());
          d.setDate(d.getDate() + i*7);
          datesArray.push(d.getFullYear() + "/" + ("0" + (d.getMonth() + 1)).slice(-2) + "/" + ("0" + d.getDate()).slice(-2))
        }

        timelapseData = []
        for(let j = 0; j < datesArray.length; j++) {
          timelapseData.push({"date": datesArray[j]})
        }

        for(let i = 0; i < data.length; i++) {
          let dateIdx = datesArray.indexOf(data[i].date)
          if(dateIdx > -1) {
            timelapseData[dateIdx][data[i].region] = data[i];
          }
        }

        let streamData = []
        for(let j = 0; j < datesArray.length; j++) {
          streamData.push({"date": datesArray[j]})
          for(let i = 0; i < regionsArray.length; i++) {
            streamData[j][regionsArray[i]] = 0
          }
        }

        for(let i = 0; i < data.length; i++) {
          let dateIdx = datesArray.indexOf(data[i].date)
          if(dateIdx > -1) {
            let region = data[i].continent
            streamData[dateIdx][region] += data[i].value
          }
        }

        let format = d3.timeParse("%Y/%m/%d");

        streamData.forEach(function(d) {
          d.date = format(d.date);
        });

        topListText
          .text(selectedSong.name + " by " + selectedSong.artist)

        let topListData = getSongYearlyTopListData(timelapseData);

        createToplist(topListData, {"country": "Country", "formatted_streams": "Streams"}, ({country, formatted_streams, position}) => ({country, formatted_streams}), "streams");


        if(streamGraph) {
          streamGraph.setData(streamData);

          //streamGraphTransition(1000);
          //histogram = chart(width, height/6, streamData, "palette", svg, histogram);
        }
        else {
          streamGraphListener = {
            buttonPressed(playing) {
              if(playing) {
                //console.log(JSON.stringify(timelapseData))
                let topListData = getSongTopListData(timelapseData[0]);

                createToplist(topListData, {"country": "Country", "formatted_streams": "Streams", "position": "Avg. ranking"}, ({country, formatted_streams, position}) => ({country, formatted_streams, position}), "streams");
                startSongTimeLapse(timelapseData);
              } else {
                //stopSongTimeLapse();
                streamGraph.pause();
              }
            }
          }

          //streamGraph = new StreamGraph(width/2, height/7, streamData, svgStreamGraph, streamGraphListener, continentColors, null)
          streamGraph = new StreamGraph(7*svgStreamGraph.node().getBoundingClientRect().width/10, 7*svgStreamGraph.node().getBoundingClientRect().height / 10, streamData, svgStreamGraph, streamGraphListener, continentColors, null)
          /*
          streamGraph.streamGraph 
            .attr("transform", "translate(" + (-streamGraph.streamGraph.node().getBoundingClientRect().width) + "," + (height  - streamGraph.streamGraph.node().getBoundingClientRect().height - 10) + ")")*/
          streamGraph.streamGraph
            .attr("transform", "translate(" + (-streamGraph.streamGraph.node().getBoundingClientRect().width) + ", 0)")

          streamGraphTransition(1000);

        }

        //alet legend = setRankLegend(width/30, height/2, [colorScale], svg);
        let legend = setRankLegend(width/20, height/3, colorScales, svg);

        legend
          .attr("transform", "translate(" + 10 + ", " + (3*height/4 - legend.node().getBoundingClientRect().height/2) + ")")

        //resize();
      }

      getAllDocuments(db.collection('entries'), {"id":selectedSong.id}, songEntriesCallback, [], {_id: 0, s: 1, r:1, d: 1, p:1})
    }
  }
}

client.login().then(() => getAllDocuments(db.collection('songs'), {}, songListCallback, [], {_id: 0, id: 1, "Track Name": 1, "Artist": 1}))

let count_par;
let count_list;

function setCountriesList() {
  
  count_par = d3.select("#Countries").select('p');
  count_list = count_par.append("ul");

  let ordered_countries = []

  for (i in worldMap.spotify_dict){
    ordered_countries.push(worldMap.spotify_dict[i])
  };

  // Singapore and Hong-kong are too small to appear in the TopoJSON. We therefore don't let the user zoom on them.
  ordered_countries = ordered_countries.filter(x => x["alpha2"] != "sg" && x["alpha2"] != "hk");

  // Order countries alphabetically
  ordered_countries = ordered_countries.sort(function(a, b){
    if(a.name < b.name) return -1;
    if(a.name > b.name) return 1;
    return 0;
  });

  //Append countries in the list
  for(let i = 0; i < ordered_countries.length; i++) {
    count_list.append("li").attr("class","country_list").attr("id", ordered_countries[i]["alpha2"]).style("list-style-type", "none")
    .text(ordered_countries[i].name);
  }

  //d3.select("#Countries").style("overflow","scroll");
  d3.select("#Countries").style("overflow","scroll");

  // 
  let songs_par = d3.select("#Songs").select('p');
  let songs_list = songs_par.append("ul"); 
      
      
  Object.keys(worldMap.spotify_dict).forEach(function(AlphA){
  count_list.select("#"+AlphA)
    .on("mouseover", function() { d3.select("#"+AlphA).style("font-weight", "bold")})
    .on("mouseout", function() { d3.select("#"+AlphA).style("font-weight", "inherit")})
    .on("click", function() {
      let AlphA = d3.select(this).attr('id');
      worldMap.zoom(AlphA);
	    //show_image('https://i.scdn.co/image/d0186ad64df7d6fc5f65c20c7d16f4279ffeb815');
    });
  });
  
}

  
let div = null;

let show_image = function(url) {

  console.log("sdfafdsa")

  d3.selectAll(".image-container").remove();

  setTimeout(function() {
    console.log("skafÃ©l")

    div = d3.select("#left").append("div")
      .attr("class", "image-container")
      .style("top", ((height-130)/2) + "px")
      .style("left", ((width-130)/2) + "px")
      .style("position", "absolute")
      .style("width", "130px")
      .style("height", "130px");

    console.log(height)
    console.log(width)

    let canvas = div
      .append("canvas")
      .attr("width", 130)
      .attr("height" , 130)
      .style('border-radius', '50%');

      //creer l'image 
      let image = new Image ();
      image.src = url;

      let context = canvas.node().getContext("2d");
        //fonction qui telecharge l'image
      image.onload = function() {
        // dessine l'image dans le contexte du canevas
        context.drawImage (image, 0, 0, 130, 130)          
      }

    }, 1000);

}

// Nathalie's code -----------------------------------
// Creates the tabs and selections 
let mode = 'song';
function Open(evt, Selection) {
	
	if (Selection === 'Countries') { mode = 'country'; }
	else { mode = 'song'}

	
	d3.selectAll(".tablinks").style("background-color" , "#eee"); 
	d3.selectAll("#btn"+Selection).style("background-color" , "#ccc"); 
	
	// Declare all variables
    let i, tabcontent, tablinks;
	
    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(Selection).style.display = "block";
    evt.currentTarget.className += " active";
}

//End of Nathalie's code----------------------------------------------------------------------------

function startSongTimeLapse(data) {

  let it = 0;
  let week = 0;

  if(data[week] == undefined) {
    console.log(data)
  }

  function setNextTimeLapse() {
    let speed = streamGraph.timelapseSpeed;
    let delta = 1000 / speed;

    timer = setTimeout(function() {  
      if(streamGraph.playing) {
        setNextTimeLapse();
      }

        
      streamGraph.setTimeStamp(it/20.0);
      if(it%20 == 0) {

        let topListData = getSongTopListData(data[week]);              
        updateToplist(speed, topListData, {"country": "Country", "formatted_streams": "Streams", "position": "# in country"}, ({country, formatted_streams, position}) => ({country, formatted_streams, position}), "streams");
  
        let countriesColors = {}

        if(data[week]) {
          for(let i = 0; i < worldMap.spotify_countries.length; i++) {
            let region = worldMap.spotify_countries[i];
            if(region in data[week]) {
              
              let position = data[week][region].position;
              /*let shade = (100 - position) * 255 / 99.0;
              countriesColors[region] = d3.color(d3.rgb(shade, shade/2, shade/2))*/

              countriesColors[region] = colorScales[CountryContinentDict[region]]((position-1)/99.0)            
              //countriesColors[region] = colorScale(position/100.0)

            }
          }
        }
        else {
          streamGraph.pause()
          //stopSongTimeLapse();
        }
        worldMap.drawMap(countriesColors, delta);

        week += 1;
        if(week == data.length) {
          streamGraph.pause();
          //stopSongTimeLapse();
        }
      }
      it++;
    }, delta/20.0);
  }

  setNextTimeLapse();
  playing = true;
}

/*
function stopSongTimeLapse() {
  clearInterval(timer);
  playing = false;
}
*/

function resize() {
  width = leftDiv.clientWidth;
  height = window.innerHeight ;

/*
  navigation
    .attr("width", width/15)
    .attr("height", width/30)
    .attr("transform", getNavigationTransform());
*/

  d3.select("svg")
    .attr("width", width)
    .attr("height", height)

  worldMap.resize(width, height)

  if(streamGraph) {
    //streamGraph.resize(width/2, height/6)

    //streamGraph.resize(width/2, height/7)
    streamGraph.resize(7*svgStreamGraph.node().getBoundingClientRect().width/10, 7*svgStreamGraph.node().getBoundingClientRect().height/10)
    streamGraphTransition(0);
  }

  if(div) {
    div
      .style("top", ((height-130)/2) + "px")
      .style("left", ((width-130)/2) + "px")
  }
} 

window.addEventListener("resize", resize);

d3.select(self.frameElement).style("height", height + "px");

let style = getComputedStyle(document.body);
let row_size = +style.getPropertyValue('--main-row-size') + 4;
let data_row_size = row_size - 2;

let spotify_green = style.getPropertyValue('--main-spotify-green');
let triangle_width = 13;
let triangle_height = 13;
let indexx = 1;
let uniqueID = 0;
let testDataset = [];
let features = {"acousticness": 0.187,	"danceability": 0.852, "energy": 0.773,	"instrumentalness": 0.0000305, "liveness": 0.159,	"speechiness": 0.0776, "valence": 0.907};
		
function parseFeatures(features){
  let temp = JSON.parse(JSON.stringify(features));
  let temp2 = {};
  temp2['axes'] = JSON.parse(JSON.stringify(d3.entries(temp)).replace(/key/g, "axis"));

  return [temp2];
}

// Define the div for the tooltip
let div_toplist = d3.select("body").append("div")	
    .attr("class", "song_tooltip")				
    .style("opacity", 0);

let tip = d3.tip().attr('class', 'd3-tip').offset([20, 30]).html("<div class='radar'></div>");

// Create a local variable for storing previous data.
let previousData = d3.local();

/*
d3.json("./jsonsamples/us_with_id.json", function(error, data) {

    //console.log(data);
    testDataset = data;
    createToplist(data, {"p": "#","n": "Title", "a": "Artist", "s": "Streams"}, ({p, n, a, s}) => ({p, n, a, s}), "s");
});*/


// Fake data
/* let tweets = {
"tweets": [
{"pos": 1, "title": "I really love seafood.", "author": "author1", "streams": 456546546},
{"pos": 2, "title": "I take that back, this doesn't taste so good.", "author": "author14", "streams": 546546},
{"pos": 3, "title": "From now on, I'm only eating cheese sandwiches.", "author": "author1324", "streams": 4645},
{"pos": 4, "title": "Great workout!", "author": "author1454", "streams": 2354656},
{"pos": 5, "title": "Spectacular oatmeal!", "author": "6756", "streams": 2354656},
{"pos": 6, "title": "Amazing traffic!", "author": "author145546", "streams": 2354656},
{"pos": 7, "title": "Just got a ticket for texting and driving!", "author": "author12343", "streams": 2354656},
{"pos": 8, "title": "Going to have some boiled eggs.", "author": "author123543", "streams": 2354656},
{"pos": 9, "title": "Maybe practice some gymnastics.", "author": "author134654", "streams": 2354656},
{"pos": 10, "title": "@Roy Let's get lunch", "author": "author13453454", "streams": 567567}
]
} */

let tweets3 = {
"tweets": [
{"p": 1, "n": "Nic", "a": "author1", "s": 346454, "id": 1234324523423},
{"p": 2, "n": "Bic", "a": "a2", "s": 4345, "id": 1234324523423},
{"p": 3, "n": "tric", "a": "a14", "s": 2354656, "id": 1234324523423},
{"p": 4, "n": "pic", "a": "a13454", "s": 2354656, "id": 1234324523423},
{"p": 5, "n": "Spectacular oatmeal!", "a": "a13454", "s": 2354656, "id": 1234324523423},
{"p": 6, "n": "Amazing traffic!", "a": "a1356456", "s": 2354656, "id": 1234324523423},
{"p": 7, "n": "Just got a ticket for texting and driving!", "a": "a1564", "s": 2354656, "id": 1234324523423},
{"p": 8, "n": "Going to have some boiled eggs.", "a": "a134565465", "s": 2354656, "id": 1234324523423},
{"p": 9, "n": "Maybe practice some gymnastics.", "a": "a1356546", "s": 2354656, "id": 1234324523423},
{"p": 10, "n": "@Roy Let's get lunch", "a": "a143564565", "s": 3453454, "id": 1234324523423}
]
}
 
// toplistData - list of json-like elements
function createToplist(toplistData, keys, filter, sortBy){  

  d3.select(".table").remove();

    toplistData = toplistData.sort(function(a, b){
        if(+a[sortBy] < +b[sortBy]) return 1;
        if(+a[sortBy] > +b[sortBy]) return -1;
        return 0;
    });

    toplistData = toplistData.slice(0,15);

    //console.log(JSON.stringify(toplistData));

    //var keyValues = d3.keys(toplistData[0]);
    //let keys = {"p": "#","n": "Title", "a": "Artist", "s": "Streams"};
    let head = rankPage
        .append("div")
        .attr("class", "table")
        .append("div")
        .attr("class", "headers")
        //.style("height", data_row_size + "px");

    console.log(d3.entries(keys))

    head.selectAll("div.header")
        .data(d3.entries(keys))
        .enter()
        .append("div")
        .attr("class", "header")
        .attr("cell_type", (d) => {return d.key;})        
        .html((d, i) => {return d.value;});


    let data_rows = d3.select("div.table").selectAll("div.datarow")
        .data(toplistData, (d) => {return d.id;})
        .enter()
        .append("div")
        .attr("class", "datarow")
        .attr("id", function(d) { return uniqueID++; })
        .style("height", data_row_size + "px")
        .style("top", (d,i) => {return (row_size + ((i) * row_size)) + "px";});

    data_rows.selectAll("div.data")
        .data((d) => { return d3.entries(filter(d));})
        .enter()
        .append("div")
        .attr("class", "data")
        .attr("cell_type", (d) => {return d.key;})
        .html((d) => {return d.value;});

    let info_image = data_rows
        .append("div")
          .attr("class", "info")
          .style("height", data_row_size + "px")
          .style("width", data_row_size + "px")
        .append("svg")
          .attr("width", 24 + "px")
          .attr("height", 24 + "px")
          .attr("class", "info")
        .append("image")
          .attr("xlink:href","img/info_icon.png")
          .attr("width", 24 + "px")
          .attr("height", 24 + "px")
          .on('mouseover', function(d) {     
            d3.select(".d3-tip").transition().style("opacity", "1");   
            tip.show(d);             
            let radarCallback = function(features) {
              //console.log(features)
              if(features[0]) {
                let svg_radar2 = RadarChart(".radar", parseFeatures(features[0]), radarChartOptions2);
              }
            }

            getAllDocuments(db.collection('songs'), {"id":d.id}, radarCallback, [], {_id: 0, "acousticness": 1, "danceability": 1, "energy": 1, "instrumentalness": 1, "liveness": 1, "speechiness": 1, "valence": 1})

          })
          .on('mouseout', function(d) {
            d3.select(".d3-tip").transition().duration(1000).style("opacity", "0").on("end", () => {d3.select("svg.radar").remove(); tip.hide;});
            
          });
          /* .on("mouseover", function(d) {		
              div_toplist.transition()		
                  .duration(200)		
                  .style("opacity", .9);		
              div_toplist	
                  .style("left", (d3.event.pageX + 10) + "px")		
                  .style("top", (d3.event.pageY - 10) + "px");

              let svg_radar2 = RadarChart(".song_tooltip", data_radar, radarChartOptions2);
            })					
          .on("mouseout", function(d) {		
              div_toplist.transition()		
                  .duration(500)		
                  .style("opacity", 0);}) */
      info_image.call(tip);

    d3.select(".d3-tip")
        .on('mouseover', function(d) { d3.select(".d3-tip").transition().style("opacity", "1");})
        .on('mouseout', function(d) {d3.select(".d3-tip").transition().duration(1000).style("opacity", "0")
            .on("end", () => {d3.select("svg.radar").remove(); tip.hide;}); });

    //data_rows.on("click", showDetails);

    d3.selectAll("[cell_type = p]")
        .each(function(d) { previousData.set(this, d.value) });
}    

function transitionSheet() {
    d3.selectAll("div.datarow")
    .transition()
    .duration(2000)
    .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size)) + "px";});
    }

function sortSheet() {
    var dataset = d3.selectAll("div.datarow").data();
    dataset.sort((a,b) => {return a.p > b.p;
        });

    d3.selectAll("div.datarow")
    .data(dataset, (d) => {return d.title;})
    .transition()
    .duration(2000)
    .style("top", (d,i) => {return (row_size + ((d.p-1) * row_size));});
    }   

function transformData() {

    // Section that only create fake data for testing purposes
    // Copy to a new variable 
    let tweets2 = JSON.parse(JSON.stringify(tweets3));
    // Add new record
    if (Math.random() > 0.3){
        while(Math.random() > 0.3){
            tweets2.tweets.push({"p": Math.round(Math.random()*20), "n": "Newone" + indexx++, 
            "a": "author1" + indexx, "s": Math.round(Math.random()*1000000), "id": 1234324523423});
        }
    }
    
    // Shuffle records
    tweets2.tweets = shuffle(tweets2.tweets);
    //Remove some of the records
    tweets2.tweets = tweets2.tweets.splice(0, tweets2.tweets.length-Math.round(Math.random()*2));
    //New ranking
    let ranking = d3.range(1, tweets2.tweets.length+1)
    // Change position of each record
    tweets2.tweets.forEach( (item, index) => {
        item.p = ranking[index];
    });

    tweets3 = JSON.parse(JSON.stringify(tweets2));


    updateToplist(0.2, tweets2.tweets, {"p": "#","n": "Title", "a": "Artist", "s": "Streams"}, ({p, n, a, s}) => ({p, n, a, s}), "s");
}

function getSongTopListData(weekData) {
  let temp = [];
  for(key in weekData) {
    if(key != "date") {
      temp.push(weekData[key])
    }
  }

  let topListData = [];
  temp.forEach(x => {
    let entry = {};
    if(worldMap.spotify_dict[x.region]) {
      entry["country"] = worldMap.spotify_dict[x.region].name;
      entry["id"] = worldMap.spotify_dict[x.region].id;
      entry["streams"] = x.value;
      entry["position"] = x.position;
      entry["formatted_streams"] = nFormatter(x.value, 3);
      topListData.push(entry);
    } else {
      console.log("Problem with " + x.region)
    }
  });

  return topListData;
}

function getSongYearlyTopListData(data) {
  let temp = [];

  for(key in worldMap.spotify_dict) {
    if(key != "date") {
      let x = {}
      x["region"] = key;
      x["value"] = data.reduce(function(a, v) {
                      if(key in v) {
                        return a + v[key].value;
                      } else {
                        return a;
                      }
                    }, 0)

      temp.push(x)
    }
  }


  let topListData = [];
  temp.forEach(x => {
    let entry = {};
    if(worldMap.spotify_dict[x.region]) {
      entry["country"] = worldMap.spotify_dict[x.region].name;
      entry["id"] = worldMap.spotify_dict[x.region].id;
      entry["streams"] = x.value;
      entry["position"] = x["avg_position"];
      entry["formatted_streams"] = nFormatter(x.value, 3);
      topListData.push(entry);
    } else {
      console.log("Problem with " + x.region)
    }
  });

  return topListData;
}

function updateToplist(speed, newToplist, keys, filter, sortBy){ 
    speed = Math.max(speed, 0.35)

    newToplist = newToplist.sort(function(a, b){
      if(+a[sortBy] < +b[sortBy]) return 1;
      if(+a[sortBy] > +b[sortBy]) return -1;
      return 0;
    });

    newToplist = newToplist.slice(0,15);

    newToplist = newToplist.map(function(d, i) {
      d["value"] = i;
    })

    //console.log(newToplist);

    // Update those that are in the table
    let rows = d3.select("div.table")
        .selectAll("div.datarow")
        .data(newToplist, (d) => {return d.id;})
        .call(savePreviousData)
        .attr("is_new", "update");
    
    let cells = rows.selectAll("div.data")
        .data((d) => {return d3.entries(filter(d));})
        .html((d) => {return d.value;})
        .attr("is_new", "update");

    rows.transition("sorting")
        .delay((d, i) => {return 100 + (i/newToplist.length) * 400/speed;})
        .duration(400/speed)
        .style("top", (d,i) => {return (row_size + ((i) * row_size)) + "px";})
        .on("start", addTriangle);

    // Add new ones
    let enterRows = rows.enter()
        .append("div")
        .attr("class", "datarow")
        .attr("id", function(d) { return uniqueID++; })
        .style("top", (d,i) => {return (row_size + ((i) * row_size)) + "px";})
        .style("opacity", 0.0)
        .style("left", "-600px")
        .style("height", data_row_size + "px")
        .attr("is_new", "enter");
        //.on("click", showDetails);

    let enter_info = enterRows
      .append("div")
      .attr("class", "info")
      .style("height", data_row_size + "px")
      .style("width", data_row_size + "px")
    .append("svg")
      .attr("width", 24 + "px")
      .attr("height", 24 + "px")
    .append("image")
      .attr("xlink:href","img/info_icon.png")
      .attr("width", 24 + "px")
      .attr("height", 24 + "px")
      .on('mouseover', function(d) {     
          d3.select(".d3-tip").transition().style("opacity", "1");   
          tip.show(d);
          let radarCallback = function(features) {
            //console.log(features)
            if(features[0]){
              let svg_radar2 = RadarChart(".radar", parseFeatures(features[0]), radarChartOptions2);
            }
          }

        getAllDocuments(db.collection('songs'), {"id":d.id}, radarCallback, [], {_id: 0, "acousticness": 1, "danceability": 1, "energy": 1, "instrumentalness": 1, "liveness": 1, "speechiness": 1, "valence": 1})                   
      })
      .on('mouseout', function(d) {
        d3.select(".d3-tip").transition().duration(200/speed).style("opacity", "0").on("end", () => {d3.select("svg.radar").remove(); tip.hide;});
        
      });
      /* .on("mouseover", function(d) {		
          div_toplist.transition()		
              .duration(200)		
              .style("opacity", .9);		
          div_toplist	
              .style("left", (d3.event.pageX + 10) + "px")		
              .style("top", (d3.event.pageY - 10) + "px");

          let svg_radar2 = RadarChart(".song_tooltip", data_radar, radarChartOptions2);
        })					
      .on("mouseout", function(d) {		
          div_toplist.transition()		
              .duration(500)		
              .style("opacity", 0);}) */
      enter_info.call(tip);

/* d3.select(".d3-tip")
    .on('mouseover', function(d) { d3.select(".d3-tip").transition().style("opacity", "1");})
    .on('mouseout', function(d) {d3.select(".d3-tip").transition().duration(1000).style("opacity", "0")
        .on("end", () => {d3.select("svg.radar").remove(); tip.hide;}); }); */

/*         .on("mouseover", function(d) {		
        div_toplist.transition()		
            .duration(200)		
            .style("opacity", .9);		
        div_toplist.html(d.id)	
            .style("left", (d3.event.pageX + 10) + "px")		
            .style("top", (d3.event.pageY - 10) + "px");	
        console.log(d.id);
        })					
    .on("mouseout", function(d) {		
        div_toplist.transition()		
            .duration(500)		
            .style("opacity", 0);	
  }); */

    let enterCells = enterRows.selectAll("div.data")
        .data((d) => {return d3.entries(filter(d));})
        .enter()
        .append("div")
        .attr("class", "data")
        .attr("cell_type", (d) => {return d.key;})
        .html((d) => {return d.value;});
    
    enterRows.transition("new_rows")
        .ease(d3.easeQuad)
        .delay(600/speed)
        .duration(200/speed)
        .style('opacity', 1.0)
        .style("left", "0px");

    rows.exit()
        .attr('is_new', 'exit')
        .transition("exit_rows")
        .ease(d3.easeQuad) //"quad" d3.v3
        .delay(0)
        .duration(200/speed)
        .style('opacity', 0.0)
        .style("left", "600px")
        .remove();
}                   
function addTriangle() {
    //let inner_data = d3.select(this).selectAll("[cell_type = p]").data();
    //console.log(inner_data[0]);

    d3.select(this).selectAll("[cell_type = p]")
        .append('svg')
        .attr("class", "triangle")
        .attr("height", triangle_height + "px")
        .attr("width", triangle_width + "px")
        .style("right", 0 + 'px')
            .append('polygon')
            .attr('points', function(d) {
                console.log(+previousData.get(this));
                console.log(+d.value);                    
                var diff = +previousData.get(this) - d.value;  // Retrieve previously stored data.               
                return diff < 0 ? "0,0 " + triangle_width + ",0 " + triangle_width/2 +"," + triangle_height + " 0,0" : 
                        diff > 0 ? "0," + triangle_height +" " + triangle_height+","+triangle_width+" "+triangle_width/2+",0 0,"+triangle_height :
                        "0," + triangle_height/2 + " " + triangle_width+","+triangle_width/2+" 0," + triangle_width/2;
                })
            .style("fill" ,function(d) {
                var diff = +previousData.get(this) - d.value; 
                return diff < 0 ? "red" : diff > 0 ? "green" : "black";
                })
            .style("stroke" ,function(d) {
                var diff = +previousData.get(this) - d.value; 
                return diff === 0 ? "black" : "";
                })
            .style("opacity", 0)
            .transition()
            .duration(1000)
            .ease(d3.easeLinear)
            .style("opacity", 1);
}
function savePreviousData() {
    d3.selectAll("[cell_type = p]").each(function(d) { console.log(this); previousData.set(this, d.value) });
}
function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}


function showDetails()
{
    let movingRows = d3.selectAll("div.datarow")
        .filter((d) => d.p > d3.select(this).datum().p);

    let movingRowsNodes = movingRows.nodes();

    movingRows.transition()
        .duration(1000)
        .style("top", (d, i) => { return +d3.select(movingRowsNodes[i]).style("top").slice(0,-2) + 30 + "px"});
}


/*
d3.select("#controls").insert("button", ".table").on("click", sortSheet).html("sort")
d3.select("#controls").insert("button", ".table").on("click", transitionSheet).html("transition")
d3.select("#controls").insert("button", ".table").on("click", transformData).html("transform")
*/

//////////////////////////////////////////////////////////////
//////////////////////// Set-Up //////////////////////////////
//////////////////////////////////////////////////////////////

var margin_radar = { top: 30, right: 40, bottom: 30, left: 40 },
width_radar = +style.getPropertyValue('--tooltip-song-size') + 60 - margin_radar.left - margin_radar.right,
height_radar = +style.getPropertyValue('--tooltip-song-size') - margin_radar.top - margin_radar.bottom;
resize();

//////////////////////////////////////////////////////////////
////////////////////////// Data //////////////////////////////
//////////////////////////////////////////////////////////////

var data_radar = [
  { name: 'Allocated budget',
    axes: [
      {axis: 'Sales', value: 42},
      {axis: 'Marketing', value: 20},
      {axis: 'Development', value: 60},
      {axis: 'Customer Support', value: 26},
      {axis: 'Information Technology', value: 35},
      {axis: 'Administration', value: 20}
    ]
  },
  { name: 'Actual Spending',
    axes: [
      {axis: 'Sales', value: 50},
      {axis: 'Marketing', value: 45},
      {axis: 'Development', value: 20},
      {axis: 'Customer Support', value: 20},
      {axis: 'Information Technology', value: 25},
      {axis: 'Administration', value: 23}
    ]
  }
];

/*     //////////////////////////////////////////////////////////////
////// First example /////////////////////////////////////////
///// (not so much options) //////////////////////////////////
//////////////////////////////////////////////////////////////
var radarChartOptions = {
  w: 290,
  h: 350,
  margin: margin,
  levels: 5,
  roundStrokes: true,
  color: d3.scaleOrdinal().range(["#26AF32", "#762712"]),
  format: '.0f'
};

// Draw the chart, get a reference the created svg element :
let svg_radar1 = RadarChart(".radarChart", data, radarChartOptions); */

//////////////////////////////////////////////////////////////
///// Second example /////////////////////////////////////////
///// Chart legend, custom color, custom unit, etc. //////////
//////////////////////////////////////////////////////////////
var radarChartOptions2 = {
  w: width_radar,
  h: height_radar,
  margin: margin_radar,
  maxValue: 1,
  levels: 5,
  roundStrokes: false,
  color: d3.scaleOrdinal().range(["#AFC52F", "#ff6600"]),
  format: '.2f',
  opacityArea: 0.2,
  opacityCircles: 0.01,
  wrapWidth: 100,
  //legend: { title: 'Organization XYZ', translateX: 100, translateY: 40 },
  //unit: '$'
};

// Draw the chart, get a reference the created svg element :
//let svg_radar2 = RadarChart(div_toplist, data_radar, radarChartOptions2);
</script>